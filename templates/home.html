{% extends "base.html" %}
{% block title %}Accueil - Boutique en ligne{% endblock %}

{% block content %}
<!-- Hero Section -->
<style>
/* Hero Section Styles */
.hero-section {
  background: linear-gradient(135deg, #158cba 0%, #0f6b96 100%);
  min-height: 80vh;
  display: flex;
  align-items: center;
  position: relative;
  overflow: hidden;
  padding-top: 2rem;
  padding-bottom: 2rem;
}

.bubbles-container {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  z-index: 1;
  pointer-events: none;
}

.bubble {
  position: absolute;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(5px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  animation: float 6s ease-in-out infinite;
  opacity: 0;
  transition: transform 0.3s ease-out;
  pointer-events: auto;
}

.bubble:nth-child(odd) { background: rgba(255, 255, 255, 0.08); animation-delay: -2s; }
.bubble:nth-child(3n) { background: rgba(255, 255, 255, 0.12); animation-delay: -4s; }
.bubble:nth-child(4n) { animation-delay: -1s; background: rgba(255, 255, 255, 0.06); }
.bubble:nth-child(5n) { animation-delay: -3s; }

@keyframes float {
  0% { transform: translateY(calc(100vh + 50px)) scale(0); opacity: 0; }
  10% { opacity: 1; }
  90% { opacity: 1; }
  100% { transform: translateY(-150px) scale(1); opacity: 0; }
}

.hero-content { position: relative; z-index: 20; pointer-events: auto; }
.hero-content * { position: relative; z-index: 21; pointer-events: auto; }

.bubble-sm { width: 25px; height: 25px; }
.bubble-md { width: 45px; height: 45px; }
.bubble-lg { width: 65px; height: 65px; }
.bubble-xl { width: 85px; height: 85px; }

.bubble-1 { left: 5%; animation-duration: 8s; }
.bubble-2 { left: 15%; animation-duration: 6s; animation-delay: -1s; }
.bubble-3 { left: 25%; animation-duration: 7s; animation-delay: -2s; }
.bubble-4 { left: 35%; animation-duration: 9s; animation-delay: -3s; }
.bubble-5 { left: 45%; animation-duration: 6s; animation-delay: -4s; }
.bubble-6 { left: 55%; animation-duration: 8s; animation-delay: -0.5s; }
.bubble-7 { left: 65%; animation-duration: 7s; animation-delay: -1.5s; }
.bubble-8 { left: 75%; animation-duration: 6s; animation-delay: -2.5s; }
.bubble-9 { left: 85%; animation-duration: 8s; animation-delay: -3.5s; }
.bubble-10 { left: 95%; animation-duration: 9s; animation-delay: -4.5s; }
.bubble-11 { left: 10%; animation-duration: 7s; animation-delay: -5s; }
.bubble-12 { left: 20%; animation-duration: 6s; animation-delay: -1.2s; }
.bubble-13 { left: 30%; animation-duration: 8s; animation-delay: -2.2s; }
.bubble-14 { left: 40%; animation-duration: 7s; animation-delay: -3.2s; }
.bubble-15 { left: 50%; animation-duration: 9s; animation-delay: -4.2s; }
.bubble-16 { left: 60%; animation-duration: 6s; animation-delay: -0.8s; }
.bubble-17 { left: 70%; animation-duration: 8s; animation-delay: -1.8s; }
.bubble-18 { left: 80%; animation-duration: 7s; animation-delay: -2.8s; }

@keyframes sway {
  0%, 100% { transform: translateX(0px); }
  50% { transform: translateX(15px); }
}

.bubble:nth-child(2n) { animation: float 6s ease-in-out infinite, sway 4s ease-in-out infinite; }
.hero-section .text-white { text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); }
.bubble.repelled { animation-play-state: paused; transform: scale(0.8); opacity: 0.3 !important; }
.bubble:hover { transform: scale(1.1); background: rgba(255, 255, 255, 0.15); border-color: rgba(255, 255, 255, 0.4); }

/* Logo positioning */
.logo-image {
  width: 60%;
  border-radius: 8px;
  margin-left: auto;
  display: block;
}

@media (max-width: 768px) {
  .hero-section { 
    min-height: 100vh; /* Increase height to ensure bubbles have room */
    padding-top: 3rem; 
    padding-bottom: 3rem; 
  }
  
  /* Ensure bubbles container covers full viewport */
  .bubbles-container {
    min-height: 100vh;
    width: 100vw;
    position: absolute;
    top: 0;
    left: 0;
  }
  
  /* Make bubbles more visible on mobile */
  .bubble {
    background: rgba(255, 255, 255, 0.15) !important; /* Slightly more opaque */
    border: 2px solid rgba(255, 255, 255, 0.25);
  }
  
  /* Adjust bubble sizes for mobile */
  .bubble-sm { width: 20px; height: 20px; }
  .bubble-md { width: 35px; height: 35px; }
  .bubble-lg { width: 50px; height: 50px; }
  .bubble-xl { width: 65px; height: 65px; }
  
  /* Ensure animation works on mobile */
  @keyframes float {
    0% { 
      transform: translateY(calc(100vh + 100px)) scale(0); 
      opacity: 0; 
    }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { 
      transform: translateY(-200px) scale(1); 
      opacity: 0; 
    }
  }
  
  /* Force hardware acceleration on mobile */
  .bubble {
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    will-change: transform, opacity;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
  }
  
  /* Reduce number of visible bubbles on mobile for better performance */
  .bubble:nth-child(n+13) {
    display: none; /* Hide bubbles 13-18 on mobile */
  }
  
  /* Adjust animation duration for better mobile performance */
  .bubble {
    animation-duration: 7s !important;
  }
  /* Center logo on mobile */
  .logo-image {
    width: 70%;
    margin-left: auto;
    margin-right: auto;
  }
}

/* Review Badge Styles */
.review-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(10px);
  padding: 5px 10px;
  border-radius: 20px;
  display: flex;
  align-items: center;
  gap: 5px;
  z-index: 2;
}

.review-badge .star-rating-display {
  display: flex;
  gap: 2px;
  font-size: 0.75rem;
}

.review-badge small {
  font-weight: 600;
  font-size: 0.85rem;
  color: white;
}

/* Product Reviews Display in Card Body */
.product-reviews {
  border-top: 1px solid #e9ecef;
  padding-top: 0.75rem;
}

.stars-small {
  display: flex;
  gap: 2px;
  font-size: 0.9rem;
}

/* Global Card Styles */
.card { border-radius: 15px !important; transition: all 0.3s ease; }

.product-card {
  position: relative;
  cursor: pointer;
  transition: all 0.3s ease;
  border-radius: 15px !important;
  overflow: hidden;
  border: 0;
}

.product-card:hover { box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1) !important; }

.card-img-container {
  position: relative;
  overflow: hidden;
  height: 200px;
}

.card-img-top {
  height: 100%;
  width: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.product-card:hover .card-img-top { transform: scale(1.1); }

.product-card .btn-add-cart {
  position: relative;
  z-index: 10;
  transition: all 0.2s ease;
}

.btn-details {
  transition: all 0.2s ease;
  font-weight: 600;
  border-radius: 8px !important;
}

.product-card:hover .btn-details {
  background-color: #127daa !important;
  color: white !important;
  border-color: #127daa !important;
}

.product-card .btn-add-cart:hover ~ * .btn-details,
.product-card:has(.btn-add-cart:hover) .btn-details {
  background-color: transparent !important;
  color: #0d6efd !important;
}

.features-section .card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
.features-section .card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
</style>

<section class="hero-section text-white py-4">
  <div class="bubbles-container">
    <div class="bubble bubble-sm bubble-1"></div>
    <div class="bubble bubble-md bubble-2"></div>
    <div class="bubble bubble-lg bubble-3"></div>
    <div class="bubble bubble-sm bubble-4"></div>
    <div class="bubble bubble-xl bubble-5"></div>
    <div class="bubble bubble-md bubble-6"></div>
    <div class="bubble bubble-sm bubble-7"></div>
    <div class="bubble bubble-lg bubble-8"></div>
    <div class="bubble bubble-md bubble-9"></div>
    <div class="bubble bubble-sm bubble-10"></div>
    <div class="bubble bubble-lg bubble-11"></div>
    <div class="bubble bubble-md bubble-12"></div>
    <div class="bubble bubble-xl bubble-13"></div>
    <div class="bubble bubble-sm bubble-14"></div>
    <div class="bubble bubble-md bubble-15"></div>
    <div class="bubble bubble-lg bubble-16"></div>
    <div class="bubble bubble-sm bubble-17"></div>
    <div class="bubble bubble-md bubble-18"></div>
  </div>

  <div class="container hero-content">
    <div class="row align-items-center mobile-reverse">
      <div class="col-lg-6 mb-3 mb-lg-0 mobile-text-container">
        <h1 class="display-5 fw-bold mb-3 text-white" style="font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;">
          Bienvenue dans notre boutique
        </h1>
        <p class="mb-3">Découvrez des produits incroyables à des prix imbattables. Achetez en toute confiance.</p>
        <a href="#featured" class="btn btn-light fw-semibold">
          <i class="fas fa-shopping-bag me-1"></i> Découvrir nos produits
        </a>
      </div>
      <div class="col-lg-6 mobile-image-container desktop-image-container">
        <img src="/static/img/image1.png"
             class="rounded logo-image" alt="mlixir dhuil">
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const bubbles = document.querySelectorAll('.bubble');
  const heroSection = document.querySelector('.hero-section');
  
  function repelBubbles(mouseX, mouseY) {
    bubbles.forEach(bubble => {
      const rect = bubble.getBoundingClientRect();
      const bubbleCenterX = rect.left + rect.width / 2;
      const bubbleCenterY = rect.top + rect.height / 2;
      
      const distance = Math.sqrt(
        Math.pow(mouseX - bubbleCenterX, 2) + 
        Math.pow(mouseY - bubbleCenterY, 2)
      );
      
      const repelRadius = 100;
      
      if (distance < repelRadius) {
        const angle = Math.atan2(bubbleCenterY - mouseY, bubbleCenterX - mouseX);
        const force = (repelRadius - distance) / repelRadius;
        const moveDistance = force * 40;
        
        const moveX = Math.cos(angle) * moveDistance;
        const moveY = Math.sin(angle) * moveDistance;
        
        bubble.style.transform = `translate(${moveX}px, ${moveY}px) scale(${0.8 + force * 0.3})`;
        bubble.classList.add('repelled');
      } else {
        bubble.style.transform = '';
        bubble.classList.remove('repelled');
      }
    });
  }
  
  if (!('ontouchstart' in window)) {
    heroSection.addEventListener('mousemove', function(e) {
      repelBubbles(e.clientX, e.clientY);
    });
    
    heroSection.addEventListener('mouseleave', function() {
      bubbles.forEach(bubble => {
        bubble.style.transform = '';
        bubble.classList.remove('repelled');
      });
    });
  }
  
  heroSection.addEventListener('touchmove', function(e) {
    const touch = e.touches[0];
    repelBubbles(touch.clientX, touch.clientY);
  });
  
  heroSection.addEventListener('touchend', function() {
    bubbles.forEach(bubble => {
      bubble.style.transform = '';
      bubble.classList.remove('repelled');
    });
  });
  
  const productCards = document.querySelectorAll('.product-card');
  
  productCards.forEach(card => {
    const addCartBtn = card.querySelector('.btn-add-cart');
    const detailsBtn = card.querySelector('.btn-details');
    
    if (addCartBtn && detailsBtn) {
      addCartBtn.addEventListener('mouseenter', function() {
        detailsBtn.style.backgroundColor = '';
        detailsBtn.style.color = '';
        detailsBtn.style.borderColor = '';
      });
      
      addCartBtn.addEventListener('mouseleave', function() {
        detailsBtn.style.backgroundColor = '';
        detailsBtn.style.color = '';
        detailsBtn.style.borderColor = '';
      });
    }
  });
});
</script>

<!-- Featured Products -->
<section class="py-4" id="featured">
  <div class="container">
    <div class="text-center mb-4">
      <h2 class="fw-bold mb-2">Produits vedettes</h2>
    </div>

    <div class="row g-4">
      {% for product in products %}
      {% set review_stats = get_product_review_stats(product.id) %}
      <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm product-card" 
             onclick="window.location.href='{{ url_for('product_detail', product_id=product.id) }}'">
          
          <!-- Image Container with Review Badge -->
          <div class="card-img-container">
            <img src="{{ product.image_url }}" 
                 class="card-img-top" 
                 alt="{{ product.name }}">
            
            <!-- Review Badge Overlay -->
            {% if review_stats.count > 0 %}
            <div class="review-badge">
              <span class="star-rating-display">
                {% for i in range(1, 6) %}
                  {% if i <= review_stats.avg_rating %}
                    <i class="fas fa-star text-warning"></i>
                  {% elif i - 0.5 <= review_stats.avg_rating %}
                    <i class="fas fa-star-half-alt text-warning"></i>
                  {% else %}
                    <i class="far fa-star text-warning"></i>
                  {% endif %}
                {% endfor %}
              </span>
              <small class="ms-1">{{ review_stats.avg_rating }}</small>
            </div>
            {% endif %}
          </div>
          
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="badge bg-secondary">{{ product.category }}</span>
            </div>
            
            <h6 class="card-title fw-bold text-dark mb-2">{{ product.name }}</h6>
            <p class="card-text text-muted small flex-grow-1 mb-3">
              {{ product.description[:80] }}...
            </p>
            
            <!-- Review Display in Card Body -->
            {% if review_stats.count > 0 %}
            <div class="product-reviews mb-2">
              <div class="d-flex align-items-center gap-2">
                <div class="stars-small">
                  {% for i in range(1, 6) %}
                    {% if i <= review_stats.avg_rating %}
                      <i class="fas fa-star text-warning"></i>
                    {% elif i - 0.5 <= review_stats.avg_rating %}
                      <i class="fas fa-star-half-alt text-warning"></i>
                    {% else %}
                      <i class="far fa-star text-muted"></i>
                    {% endif %}
                  {% endfor %}
                </div>
                <small class="text-muted">
                  <strong>{{ review_stats.avg_rating }}</strong>
                  ({{ review_stats.count }} avis)
                </small>
              </div>
            </div>
            {% else %}
            <div class="product-reviews mb-2">
              <small class="text-muted">
                <i class="far fa-star text-muted"></i> Aucun avis
              </small>
            </div>
            {% endif %}
            
            <div class="mt-auto">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="fw-bold text-primary fs-5">{{ "%.2f"|format(product.price) }} DH</span>
              </div>
              
              <div class="d-grid gap-2">
                {% if current_user.is_authenticated %}
                <a href="{{ url_for('add_to_cart', product_id=product.id) }}" 
                   class="btn btn-primary btn-sm btn-add-cart"
                   onclick="event.stopPropagation();">
                  <i class="fas fa-cart-plus me-1"></i> Ajouter au panier
                </a>
                {% endif %}
                <a href="{{ url_for('product_detail', product_id=product.id) }}" 
                   class="btn btn-outline-primary btn-sm btn-details"
                   onclick="event.stopPropagation();">
                  <i class="fas fa-eye me-1"></i>Voir les détails
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="text-center mt-4">
      <a href="{{ url_for('products') }}" class="btn btn-primary">
        Voir tous les produits <i class="fas fa-arrow-right"></i>
      </a>
    </div>
  </div>
</section>

<!-- Features Section -->
<section class="py-4 bg-light features-section">
  <div class="container">
    <div class="text-center mb-4">
      <h2 class="fw-bold">Pourquoi nous choisir ?</h2>
    </div>

    <div class="row g-4">
      <div class="col-md-4 text-center">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body p-4">
            <div class="mb-3">
              <i class="fas fa-shipping-fast fa-3x text-primary"></i>
            </div>
            <h5 class="fw-bold">Livraison rapide</h5>
            <p class="text-muted small mb-0">
              Recevez vos commandes rapidement et en sécurité à votre porte.
            </p>
          </div>
        </div>
      </div>

      <div class="col-md-4 text-center">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body p-4">
            <div class="mb-3">
              <i class="fas fa-shield-alt fa-3x text-primary"></i>
            </div>
            <h5 class="fw-bold">Paiement sécurisé</h5>
            <p class="text-muted small mb-0">
              Vos informations de paiement sont sécurisées avec notre système crypté.
            </p>
          </div>
        </div>
      </div>

      <div class="col-md-4 text-center">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body p-4">
            <div class="mb-3">
              <i class="fas fa-headset fa-3x text-primary"></i>
            </div>
            <h5 class="fw-bold">Support 24h/24 7j/7</h5>
            <p class="text-muted small mb-0">
              Notre équipe de support client est toujours là pour vous aider.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}