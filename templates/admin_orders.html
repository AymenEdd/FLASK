{% extends "base.html" %}
{% block title %}Admin - Gestion des Commandes{% endblock %}

{% block content %}
<div style="padding-top: 80px;"></div>
<div style="padding-top: 80px;"></div>

<div class="container-fluid py-4">
  <!-- Section d'en-tête -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>Gestion des Commandes</h2>
      <p class="text-muted mb-0">Gérer toutes les commandes clients de la plateforme</p>
    </div>
    <div>
      <a href="{{ url_for('admin_products') }}" class="btn btn-outline-primary me-2">
        Gérer les Produits
      </a>
      <a href="{{ url_for('create_test_order') }}" class="btn btn-success">
        Créer Commande Test
      </a>
    </div>
  </div>

  <!-- Cartes de Statistiques -->
  {% if stats %}
  <div class="row mb-4" id="statsCards">
    <div class="col-md-3">
      <div class="card text-center bg-primary text-white">
        <div class="card-body">
          <h3 class="mb-0" id="totalOrdersCount">{{ stats.total_orders }}</h3>
          <small>Total des Commandes</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center bg-warning text-white">
        <div class="card-body">
          <h3 class="mb-0" id="pendingOrdersCount">{{ stats.pending_orders }}</h3>
          <small>En Attente</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center bg-info text-white">
        <div class="card-body">
          <h3 class="mb-0" id="processingOrdersCount">{{ stats.processing_orders }}</h3>
          <small>En Traitement</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center bg-success text-white">
        <div class="card-body">
          <h3 class="mb-0" id="totalRevenueCount">DH{{ "%.0f"|format(stats.total_revenue) }}</h3>
          <small>Chiffre d'Affaires</small>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Filtres Avancés -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row align-items-end">
        <div class="col-md-3">
          <label class="form-label">Filtrer par Statut :</label>
          <select id="statusFilter" class="form-select">
            <option value="">Toutes les Commandes</option>
            <option value="pending">En Attente</option>
            <option value="processing">En Traitement</option>
            <option value="shipped">Expédiée</option>
            <option value="delivered">Livrée</option>
            <option value="completed">Terminée</option>
            <option value="cancelled">Annulée</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Rechercher Client :</label>
          <div class="input-group">
            <input type="text" id="customerSearch" class="form-control" placeholder="Nom d'utilisateur ou email...">
            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label">Trier par :</label>
          <select id="sortOrder" class="form-select">
            <option value="date-desc">Plus Récentes</option>
            <option value="date-asc">Plus Anciennes</option>
            <option value="total-desc">Montant ↓</option>
            <option value="total-asc">Montant ↑</option>
            <option value="customer-asc">Client A-Z</option>
          </select>
        </div>
        <div class="col-md-2">
          <button type="button" class="btn btn-secondary w-100" onclick="clearAllFilters()">
            <i class="fas fa-undo"></i> Effacer
          </button>
        </div>
        <div class="col-md-2 text-end">
          <small class="text-muted">
            Affichage <span id="visibleCount">{{ orders.items|length if orders.items else 0 }}</span> 
            sur <span id="totalCount">{{ orders.total if orders else 0 }}</span> commandes
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Tableau des Commandes -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Toutes les Commandes</h5>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-info" onclick="exportOrders()">
          <i class="fas fa-download"></i> Exporter
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="refreshOrders()">
          <i class="fas fa-sync-alt"></i> Actualiser
        </button>
      </div>
    </div>
    <div class="card-body p-0">
      {% if orders and orders.items %}
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>
                <input type="checkbox" id="selectAll" class="form-check-input"> 
                Référence
              </th>
              <th>Client</th>
              <th>Date</th>
              <th>Total</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
            {% for order in orders.items %}
            <tr class="order-row" 
                data-status="{{ order.status }}" 
                data-customer="{{ order.user.username|lower }} {{ order.user.email|lower }}"
                data-date="{{ order.created_at.strftime('%Y-%m-%d %H:%M:%S') }}"
                data-total="{{ order.total }}"
                data-order-id="{{ order.id }}">
              <td>
                <div class="d-flex align-items-center">
                  <input type="checkbox" class="form-check-input me-2 order-checkbox" value="{{ order.id }}">
                  <strong>{{ order.title }}</strong>
                </div>
              </td>
              <td>
                <div class="customer-info">
                  <strong>{{ order.user.username }}</strong>
                  <br>
                  <small class="text-muted">{{ order.user.email }}</small>
                </div>
              </td>
              <td>
                <div>
                  {{ order.created_at.strftime('%d %b %Y') }}
                  <br>
                  <small class="text-muted">{{ order.created_at.strftime('%H:%M') }}</small>
                </div>
              </td>
              <td>
                <strong class="text-success order-total">DH{{ "%.2f"|format(order.total) }}</strong>
              </td>
              <td>
                <span class="badge order-status bg-{{ 'warning' if order.status == 'pending' 
                                        else 'info' if order.status == 'processing' 
                                        else 'primary' if order.status == 'shipped' 
                                        else 'success' if order.status in ['delivered', 'completed'] 
                                        else 'danger' }}">
                  {% if order.status == 'pending' %}En Attente
                  {% elif order.status == 'processing' %}En Traitement
                  {% elif order.status == 'shipped' %}Expédiée
                  {% elif order.status == 'delivered' %}Livrée
                  {% elif order.status == 'completed' %}Terminée
                  {% elif order.status == 'cancelled' %}Annulée
                  {% else %}{{ order.status|title }}
                  {% endif %}
                </span>
              </td>
              <td>
                <div class="btn-group" role="group">
                  <!-- Bouton Voir Détails -->
                  <a href="{{ url_for('admin_order_detail', order_id=order.id) }}" 
                     class="btn btn-sm btn-outline-primary" title="Voir Détails">
                    <i class="fas fa-eye"></i>
                  </a>
                  
                  <!-- Bouton Vue Debug -->
                  <a href="{{ url_for('debug_order_detail', order_id=order.id) }}" 
                     class="btn btn-sm btn-outline-info" title="Vue Debug">
                    <i class="fas fa-bug"></i>
                  </a>
                  
                  <!-- Mise à Jour Rapide du Statut -->
                  <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                            data-bs-toggle="dropdown">
                      <i class="fas fa-edit"></i>
                    </button>
                    <ul class="dropdown-menu">
                      {% for status_key, status_label in [
                        ('pending', 'En Attente'),
                        ('processing', 'En Traitement'),
                        ('shipped', 'Expédiée'),
                        ('delivered', 'Livrée'),
                        ('completed', 'Terminée'),
                        ('cancelled', 'Annulée')
                      ] %}
                      <li>
                        <form method="POST" action="{{ url_for('update_order_status', order_id=order.id) }}" 
                              style="display: inline;" onsubmit="handleStatusUpdate(event, {{ order.id }}, '{{ status_key }}')">
                          <input type="hidden" name="status" value="{{ status_key }}">
                          <button type="submit" class="dropdown-item {{ 'active' if order.status == status_key else '' }}"
                                  onclick="return confirm('Changer le statut vers {{ status_label|lower }} ?')">
                            <i class="fas fa-{{ 'clock' if status_key == 'pending' 
                                           else 'cog' if status_key == 'processing'
                                           else 'shipping-fast' if status_key == 'shipped'
                                           else 'truck' if status_key == 'delivered'
                                           else 'check-circle' if status_key == 'completed'
                                           else 'times' }} me-2"></i>
                            {{ status_label }}
                          </button>
                        </form>
                      </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Barre d'Actions en Lot -->
      <div class="card-footer d-none" id="bulkActionsBar">
        <div class="d-flex justify-content-between align-items-center">
          <span class="text-muted">
            <span id="selectedCount">0</span> commandes sélectionnées
          </span>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">
              Actions en Lot
            </button>
            <ul class="dropdown-menu">
              <li><button class="dropdown-item" onclick="bulkUpdateStatus('processing')">
                <i class="fas fa-cog me-2"></i>Mettre en Traitement
              </button></li>
              <li><button class="dropdown-item" onclick="bulkUpdateStatus('shipped')">
                <i class="fas fa-shipping-fast me-2"></i>Marquer comme Expédiées
              </button></li>
              <li><button class="dropdown-item" onclick="bulkUpdateStatus('completed')">
                <i class="fas fa-check-circle me-2"></i>Marquer comme Terminées
              </button></li>
              <li><hr class="dropdown-divider"></li>
              <li><button class="dropdown-item text-danger" onclick="bulkDelete()">
                <i class="fas fa-trash me-2"></i>Supprimer Sélectionnées
              </button></li>
            </ul>
          </div>
        </div>
      </div>

      {% else %}
      <!-- Aucune Commande Trouvée -->
      <div class="text-center py-5" id="noOrdersMessage">
        <div class="mb-3">
          <i class="fas fa-inbox fa-3x text-muted"></i>
        </div>
        <h5 class="text-muted">Aucune Commande Trouvée</h5>
        <p class="text-muted mb-3">
          Aucune commande ne correspond aux filtres actuels.
        </p>
        <div>
          <button class="btn btn-primary" onclick="clearAllFilters()">
            <i class="fas fa-undo"></i> Effacer les Filtres
          </button>
          <a href="{{ url_for('create_test_order') }}" class="btn btn-success">
            <i class="fas fa-plus"></i> Créer Commande Test
          </a>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Informations de Debug (À supprimer en production) -->
  <div class="mt-4">
    <div class="card border-info">
      <div class="card-header bg-info text-white">
        <h6 class="mb-0">Informations de Debug</h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <small>
              <strong>Utilisateur Actuel :</strong> {{ current_user.username }}<br>
              <strong>Est Admin :</strong> {{ current_user.is_admin }}<br>
              <strong>Total Commandes en BDD :</strong> {{ stats.total_orders if stats else 'N/A' }}
            </small>
          </div>
          <div class="col-md-6">
            <small>
              <strong>Filtre Appliqué :</strong> <span id="debugCurrentFilter">Aucun</span><br>
              <strong>Commandes Récupérées :</strong> {{ orders.items|length if orders and orders.items else 0 }}<br>
              <strong>Page Actuelle :</strong> {{ orders.page if orders else 1 }}
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Obtenir les éléments de filtre
    const statusFilter = document.getElementById('statusFilter');
    const customerSearch = document.getElementById('customerSearch');
    const sortOrder = document.getElementById('sortOrder');
    const selectAll = document.getElementById('selectAll');
    
    // Obtenir les éléments d'affichage
    const visibleCount = document.getElementById('visibleCount');
    const totalCount = document.getElementById('totalCount');
    const debugCurrentFilter = document.getElementById('debugCurrentFilter');
    const noOrdersMessage = document.getElementById('noOrdersMessage');
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const selectedCount = document.getElementById('selectedCount');
    
    // Obtenir toutes les lignes de commandes
    const orderRows = document.querySelectorAll('.order-row');
    const totalOrders = orderRows.length;
    
    // Écouteurs d'événements
    statusFilter.addEventListener('change', filterOrders);
    customerSearch.addEventListener('input', debounce(filterOrders, 300));
    sortOrder.addEventListener('change', filterOrders);
    selectAll.addEventListener('change', toggleSelectAll);
    
    // Ajouter des écouteurs aux cases à cocher individuelles
    document.querySelectorAll('.order-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActions);
    });
    
    function filterOrders() {
        const statusValue = statusFilter.value.toLowerCase();
        const searchValue = customerSearch.value.toLowerCase().trim();
        const sortValue = sortOrder.value;
        
        let visibleOrders = [];
        let filteredOrders = Array.from(orderRows);
        
        // Filtrer par statut
        if (statusValue) {
            filteredOrders = filteredOrders.filter(row => {
                return row.dataset.status === statusValue;
            });
        }
        
        // Filtrer par recherche client
        if (searchValue) {
            filteredOrders = filteredOrders.filter(row => {
                return row.dataset.customer.includes(searchValue);
            });
        }
        
        // Trier les commandes
        filteredOrders.sort((a, b) => {
            switch(sortValue) {
                case 'date-desc':
                    return new Date(b.dataset.date) - new Date(a.dataset.date);
                case 'date-asc':
                    return new Date(a.dataset.date) - new Date(b.dataset.date);
                case 'total-desc':
                    return parseFloat(b.dataset.total) - parseFloat(a.dataset.total);
                case 'total-asc':
                    return parseFloat(a.dataset.total) - parseFloat(b.dataset.total);
                case 'customer-asc':
                    return a.dataset.customer.localeCompare(b.dataset.customer);
                default:
                    return 0;
            }
        });
        
        // Afficher/masquer les commandes
        orderRows.forEach(row => {
            if (filteredOrders.includes(row)) {
                row.style.display = '';
                visibleOrders.push(row);
            } else {
                row.style.display = 'none';
                // Décocher les cases cachées
                const checkbox = row.querySelector('.order-checkbox');
                if (checkbox) checkbox.checked = false;
            }
        });
        
        // Réorganiser les lignes visibles dans le tableau
        const tableBody = document.getElementById('ordersTableBody');
        filteredOrders.forEach(row => {
            tableBody.appendChild(row);
        });
        
        // Mettre à jour les compteurs
        visibleCount.textContent = visibleOrders.length;
        
        // Mettre à jour les infos de debug
        const filters = [];
        if (statusValue) filters.push(`Statut: ${statusValue}`);
        if (searchValue) filters.push(`Recherche: "${searchValue}"`);
        debugCurrentFilter.textContent = filters.length > 0 ? filters.join(', ') : 'Aucun';
        
        // Afficher/masquer le message d'absence de commandes
        const hasVisibleOrders = visibleOrders.length > 0;
        const tableContainer = document.querySelector('.table-responsive');
        if (tableContainer) {
            tableContainer.style.display = hasVisibleOrders ? '' : 'none';
        }
        
        // Mettre à jour les cartes de statistiques
        updateStatistics(filteredOrders);
        
        // Mettre à jour les actions en lot
        updateBulkActions();
    }
    
    function updateStatistics(visibleOrders) {
        const stats = {
            total: visibleOrders.length,
            pending: 0,
            processing: 0,
            revenue: 0
        };
        
        visibleOrders.forEach(row => {
            const status = row.dataset.status;
            const total = parseFloat(row.dataset.total);
            
            if (status === 'pending') stats.pending++;
            if (status === 'processing') stats.processing++;
            if (status === 'completed') stats.revenue += total;
        });
        
        // Mettre à jour les cartes de stats
        const totalOrdersCount = document.getElementById('totalOrdersCount');
        const pendingOrdersCount = document.getElementById('pendingOrdersCount');
        const processingOrdersCount = document.getElementById('processingOrdersCount');
        const totalRevenueCount = document.getElementById('totalRevenueCount');
        
        if (totalOrdersCount) totalOrdersCount.textContent = stats.total;
        if (pendingOrdersCount) pendingOrdersCount.textContent = stats.pending;
        if (processingOrdersCount) processingOrdersCount.textContent = stats.processing;
        if (totalRevenueCount) totalRevenueCount.textContent = `DH${Math.round(stats.revenue)}`;
    }
    
    function toggleSelectAll() {
        const visibleCheckboxes = Array.from(document.querySelectorAll('.order-checkbox'))
            .filter(cb => cb.closest('.order-row').style.display !== 'none');
        
        visibleCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateBulkActions();
    }
    
    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
        const count = checkedBoxes.length;
        
        selectedCount.textContent = count;
        
        if (count > 0) {
            bulkActionsBar.classList.remove('d-none');
        } else {
            bulkActionsBar.classList.add('d-none');
        }
        
        // Mettre à jour la case "tout sélectionner"
        const visibleCheckboxes = Array.from(document.querySelectorAll('.order-checkbox'))
            .filter(cb => cb.closest('.order-row').style.display !== 'none');
        const allChecked = visibleCheckboxes.length > 0 && visibleCheckboxes.every(cb => cb.checked);
        const someChecked = visibleCheckboxes.some(cb => cb.checked);
        
        selectAll.checked = allChecked;
        selectAll.indeterminate = someChecked && !allChecked;
    }
    
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Rendre les fonctions disponibles globalement
    window.clearSearch = function() {
        customerSearch.value = '';
        filterOrders();
    };
    
    window.clearAllFilters = function() {
        statusFilter.value = '';
        customerSearch.value = '';
        sortOrder.value = 'date-desc';
        selectAll.checked = false;
        document.querySelectorAll('.order-checkbox:checked').forEach(cb => cb.checked = false);
        filterOrders();
    };
    
    window.refreshOrders = function() {
        location.reload();
    };
    
    window.exportOrders = function() {
        const visibleOrders = Array.from(orderRows).filter(row => row.style.display !== 'none');
        const data = visibleOrders.map(row => ({
            reference: row.querySelector('strong').textContent,
            client: row.querySelector('.customer-info strong').textContent,
            email: row.querySelector('.customer-info small').textContent,
            date: row.dataset.date,
            total: row.dataset.total,
            statut: row.querySelector('.order-status').textContent
        }));
        
        const csv = [
            ['Référence', 'Client', 'Email', 'Date', 'Total', 'Statut'],
            ...data.map(order => [order.reference, order.client, order.email, order.date, order.total, order.statut])
        ].map(row => row.join(',')).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `commandes-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    };
    
    window.bulkUpdateStatus = function(newStatus) {
        const selectedOrders = Array.from(document.querySelectorAll('.order-checkbox:checked'));
        if (selectedOrders.length === 0) return;
        
        const statusLabels = {
            'processing': 'en traitement',
            'shipped': 'expédiées',
            'completed': 'terminées'
        };
        
        if (confirm(`Mettre à jour ${selectedOrders.length} commandes vers ${statusLabels[newStatus]} ?`)) {
            selectedOrders.forEach(checkbox => {
                const orderId = checkbox.value;
                const row = checkbox.closest('.order-row');
                
                // Mettre à jour l'affichage immédiatement
                row.dataset.status = newStatus;
                const statusBadge = row.querySelector('.order-status');
                
                const statusDisplayNames = {
                    'processing': 'En Traitement',
                    'shipped': 'Expédiée',
                    'completed': 'Terminée'
                };
                
                statusBadge.textContent = statusDisplayNames[newStatus];
                statusBadge.className = `badge order-status bg-${getStatusColor(newStatus)}`;
                
                // Envoyer la mise à jour au serveur (à implémenter)
                // fetch(`/admin/orders/${orderId}/update_status`, {...})
            });
            
            filterOrders();
        }
    };
    
    window.bulkDelete = function() {
        const selectedOrders = Array.from(document.querySelectorAll('.order-checkbox:checked'));
        if (selectedOrders.length === 0) return;
        
        if (confirm(`Supprimer ${selectedOrders.length} commandes ? Cette action ne peut pas être annulée.`)) {
            selectedOrders.forEach(checkbox => {
                const row = checkbox.closest('.order-row');
                row.remove();
            });
            
            filterOrders();
        }
    };
    
    function getStatusColor(status) {
        switch(status) {
            case 'pending': return 'warning';
            case 'processing': return 'info';
            case 'shipped': return 'primary';
            case 'delivered':
            case 'completed': return 'success';
            case 'cancelled': return 'danger';
            default: return 'secondary';
        }
    }
});
</script>

<style>
.btn-group .dropdown-menu {
  min-width: 150px;
}

.dropdown-item.active {
  background-color: #0d6efd;
  color: white;
}

.order-row {
  transition: all 0.3s ease;
}

.table-responsive {
  transition: opacity 0.3s ease;
}

#bulkActionsBar {
  background-color: #f8f9fa;
  border-top: 1px solid #dee2e6;
}

.customer-info {
  min-width: 150px;
}

@media (max-width: 768px) {
  .btn-group {
    display: block;
  }
  
  .btn-group .btn {
    display: block;
    width: 100%;
    margin-bottom: 2px;
  }
  
  .card-body .row > div {
    margin-bottom: 1rem;
  }
}
</style>
{% endblock %}