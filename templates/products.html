{% extends "base.html" %}
{% block title %}Produits - Boutique en ligne{% endblock %}

{% block content %}
<div style="padding-top: 80px;"></div>
<div class="container py-4">
  <div class="row pt-5 pb-4">
    <div class="col-12">
      <h1 class="h3 text-uppercase fw-normal mb-0" style="letter-spacing: 2px; font-size: 1.5rem;">Nos produits</h1>
    </div>
  </div>

  <!-- Category Filter with Search -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h5 class="card-title mb-3">Filtrer les produits</h5>
              <div class="btn-group flex-wrap" role="group" id="categoryFilters">
                <button type="button" class="btn btn-outline-primary active" data-category="all">
                  Toutes les catégories
                </button>
                {% for category in categories %}
                <button type="button" class="btn btn-outline-primary mx-1" data-category="{{ category[0] }}">
                  {{ category[0] }}
                </button>
                {% endfor %}
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="searchInput" class="form-label">Rechercher des produits</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="searchInput" placeholder="Rechercher par nom...">
                  <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="inStockOnly">
                <label class="form-check-label" for="inStockOnly">
                  En stock seulement
                </label>
              </div>
            </div>
          </div>
          
          <!-- Results Summary -->
          <div class="row mt-3">
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted" id="resultsCount">
                  Chargement...
                </small>
                <div class="btn-group btn-group-sm" role="group">
                  <button type="button" class="btn btn-outline-secondary" data-sort="price">
                    Prix <i class="fas fa-sort"></i>
                  </button>
                  <button type="button" class="btn btn-outline-secondary" data-sort="name">
                    Nom <i class="fas fa-sort"></i>
                  </button>
                  <button type="button" class="btn btn-outline-secondary" data-sort="rating">
                    Note <i class="fas fa-sort"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div id="loadingIndicator" style="display: none;" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
    <p class="mt-3 text-muted">Chargement des produits...</p>
  </div>

  <!-- Products Grid -->
  <div class="row" id="productsGrid">
    <!-- Products will be loaded here via AJAX -->
  </div>

  <!-- No Results Message -->
  <div class="row" id="noResults" style="display: none;">
    <div class="col-12 text-center py-5">
      <i class="fas fa-search fa-3x text-muted mb-3"></i>
      <h4 class="text-muted">Aucun produit trouvé</h4>
      <p class="text-muted">Essayez d'ajuster vos filtres ou vos termes de recherche.</p>
      <button class="btn btn-primary" onclick="clearAllFilters()">
        <i class="fas fa-undo"></i> Effacer tous les filtres
      </button>
    </div>
  </div>

  <!-- Pagination -->
  <nav aria-label="Pagination des produits" id="paginationContainer">
    <!-- Pagination will be loaded here via AJAX -->
  </nav>
</div>

<script>
// Global state management
const state = {
  page: 1,
  category: 'all',
  search: '',
  inStock: false,
  sortBy: 'name',
  sortOrder: 'asc'
};

// Debounce function
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func(...args), wait);
  };
}

// Load products via AJAX
async function loadProducts(pushState = true) {
  const loadingIndicator = document.getElementById('loadingIndicator');
  const productsGrid = document.getElementById('productsGrid');
  const noResults = document.getElementById('noResults');
  const paginationContainer = document.getElementById('paginationContainer');
  
  // Show loading
  loadingIndicator.style.display = 'block';
  productsGrid.style.opacity = '0.5';
  
  // Build query parameters
  const params = new URLSearchParams({
    page: state.page,
    category: state.category,
    search: state.search,
    in_stock: state.inStock,
    sort: state.sortBy,
    order: state.sortOrder,
    ajax: '1'
  });
  
  try {
    const response = await fetch(`/products/api?${params.toString()}`);
    const data = await response.json();
    
    // Update products grid
    productsGrid.innerHTML = data.html;
    
    // Update pagination
    paginationContainer.innerHTML = data.pagination;
    
    // Update results count
    document.getElementById('resultsCount').textContent = 
      `Affichage de ${data.count} produits sur ${data.total}`;
    
    // Show/hide no results message
    if (data.count === 0) {
      noResults.style.display = 'block';
      productsGrid.style.display = 'none';
    } else {
      noResults.style.display = 'none';
      productsGrid.style.display = 'flex';
    }
    
    // Update URL without refresh
    if (pushState) {
      const url = new URL(window.location);
      url.searchParams.set('page', state.page);
      url.searchParams.set('category', state.category);
      url.searchParams.set('search', state.search);
      url.searchParams.set('in_stock', state.inStock);
      url.searchParams.set('sort', state.sortBy);
      url.searchParams.set('order', state.sortOrder);
      window.history.pushState({}, '', url);
    }
    
  } catch (error) {
    console.error('Error loading products:', error);
    productsGrid.innerHTML = '<div class="col-12"><p class="text-danger">Erreur lors du chargement des produits</p></div>';
  } finally {
    loadingIndicator.style.display = 'none';
    productsGrid.style.opacity = '1';
  }
}

// Navigate to product detail
function navigateToProduct(url) {
  window.location.href = url;
}

// Clear search
function clearSearch() {
  document.getElementById('searchInput').value = '';
  state.search = '';
  state.page = 1;
  loadProducts();
}

// Clear all filters
function clearAllFilters() {
  state.page = 1;
  state.category = 'all';
  state.search = '';
  state.inStock = false;
  state.sortBy = 'name';
  state.sortOrder = 'asc';
  
  document.getElementById('searchInput').value = '';
  document.getElementById('inStockOnly').checked = false;
  
  // Update category buttons
  document.querySelectorAll('[data-category]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.category === 'all');
  });
  
  // Update sort buttons
  document.querySelectorAll('[data-sort]').forEach(btn => {
    btn.classList.remove('active');
    btn.querySelector('i').className = 'fas fa-sort';
  });
  
  loadProducts();
}

// Change page
function changePage(page) {
  state.page = page;
  loadProducts();
  
  // Scroll after a brief delay to ensure smooth behavior
  setTimeout(() => {
    const productsGrid = document.getElementById('productsGrid');
    if (productsGrid) {
      const offsetTop = productsGrid.offsetTop - 120;
      window.scrollTo({ top: offsetTop, behavior: 'smooth' });
    }
  }, 100);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Read initial state from URL
  const urlParams = new URLSearchParams(window.location.search);
  state.page = parseInt(urlParams.get('page')) || 1;
  state.category = urlParams.get('category') || 'all';
  state.search = urlParams.get('search') || '';
  state.inStock = urlParams.get('in_stock') === 'true';
  state.sortBy = urlParams.get('sort') || 'name';
  state.sortOrder = urlParams.get('order') || 'asc';
  
  // Set form values
  document.getElementById('searchInput').value = state.search;
  document.getElementById('inStockOnly').checked = state.inStock;
  
  // Category filter buttons
  document.querySelectorAll('[data-category]').forEach(button => {
    if (button.dataset.category === state.category) {
      button.classList.add('active');
    }
    
    button.addEventListener('click', function() {
      document.querySelectorAll('[data-category]').forEach(btn => 
        btn.classList.remove('active')
      );
      this.classList.add('active');
      state.category = this.dataset.category;
      state.page = 1;
      loadProducts();
    });
  });
  
  // Search input
  const searchInput = document.getElementById('searchInput');
  searchInput.addEventListener('input', debounce(() => {
    state.search = searchInput.value.trim();
    state.page = 1;
    loadProducts();
  }, 500));
  
  // Stock filter
  document.getElementById('inStockOnly').addEventListener('change', function() {
    state.inStock = this.checked;
    state.page = 1;
    loadProducts();
  });
  
  // Sort buttons
  document.querySelectorAll('[data-sort]').forEach(button => {
    button.addEventListener('click', function() {
      const sortType = this.dataset.sort;
      
      // Toggle order if same sort type
      if (state.sortBy === sortType) {
        state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        state.sortBy = sortType;
        state.sortOrder = sortType === 'rating' ? 'desc' : 'asc';
      }
      
      // Update button states
      document.querySelectorAll('[data-sort]').forEach(btn => {
        btn.classList.remove('active');
        btn.querySelector('i').className = 'fas fa-sort';
      });
      
      this.classList.add('active');
      const icon = this.querySelector('i');
      icon.className = state.sortOrder === 'desc' ? 'fas fa-sort-down' : 'fas fa-sort-up';
      
      state.page = 1;
      loadProducts();
    });
  });
  
  // Load initial products
  loadProducts(false);
});

// Handle browser back/forward
window.addEventListener('popstate', function() {
  const urlParams = new URLSearchParams(window.location.search);
  state.page = parseInt(urlParams.get('page')) || 1;
  state.category = urlParams.get('category') || 'all';
  state.search = urlParams.get('search') || '';
  state.inStock = urlParams.get('in_stock') === 'true';
  state.sortBy = urlParams.get('sort') || 'name';
  state.sortOrder = urlParams.get('order') || 'asc';
  
  loadProducts(false);
});
</script>

<style>
.card {
  border-radius: 15px !important;
  transition: all 0.3s ease;
}

.btn {
  border-radius: 10px !important;
  transition: all 0.3s ease;
}

.badge {
  border-radius: 50px !important;
}

.btn-group .btn {
  margin-bottom: 5px;
}

.btn-group-sm .btn.active {
  background-color: #0d6efd;
  color: white;
  border-color: #0d6efd;
}

#productsGrid {
  display: flex;
  flex-wrap: wrap;
  transition: opacity 0.3s ease;
}

.product-card {
  position: relative;
  cursor: pointer;
  transition: all 0.3s ease;
  border-radius: 15px !important;
  overflow: hidden;
  border: 0;
}

.product-card:hover {
  box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1) !important;
}

.card-img-container {
  position: relative;
  overflow: hidden;
  height: 200px;
}

.card-img-top {
  height: 100%;
  width: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.product-card:hover .card-img-top {
  transform: scale(1.1);
}

.review-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(10px);
  padding: 5px 10px;
  border-radius: 20px;
  display: flex;
  align-items: center;
  gap: 5px;
  z-index: 2;
}

.review-badge .star-rating-display {
  display: flex;
  gap: 2px;
  font-size: 0.75rem;
}

.product-reviews {
  border-top: 1px solid #e9ecef;
  padding-top: 0.75rem;
}

.stars-small {
  display: flex;
  gap: 2px;
  font-size: 0.9rem;
}

@media (max-width: 768px) {
  .btn-group {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
  }
  
  .btn-group .btn {
    flex: 1 1 auto;
    min-width: 120px;
  }
  
  .card-img-container {
    height: 180px;
  }
}
</style>
{% endblock %}