{% extends "base.html" %}
{% block title %}Admin - Gestion des Commandes{% endblock %}

{% block content %}
<div style="padding-top: 80px;"></div>
<div style="padding-top: 80px;"></div>

<div class="container-fluid py-4">
  <!-- Section d'en-tête -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>Gestion des Commandes</h2>
      <p class="text-muted mb-0">Gérer toutes les commandes clients de la plateforme</p>
    </div>
    <div>
      <a href="{{ url_for('admin_products') }}" class="btn btn-outline-primary me-2">
        Gérer les Produits
      </a>
      <a href="{{ url_for('create_test_order') }}" class="btn btn-success">
        Créer Commande Test
      </a>
    </div>
  </div>

  <!-- Cartes de Statistiques -->
  {% if stats %}
  <div class="row mb-4" id="statsCards">
    <div class="col-md-3">
      <div class="card text-center bg-primary text-white">
        <div class="card-body">
          <h3 class="mb-0" id="totalOrdersCount">{{ stats.total_orders }}</h3>
          <small>Total des Commandes</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center bg-warning text-white">
        <div class="card-body">
          <h3 class="mb-0" id="pendingOrdersCount">{{ stats.pending_orders }}</h3>
          <small>En Attente</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center bg-info text-white">
        <div class="card-body">
          <h3 class="mb-0" id="processingOrdersCount">{{ stats.processing_orders }}</h3>
          <small>En Traitement</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center bg-success text-white">
        <div class="card-body">
          <h3 class="mb-0" id="totalRevenueCount">DH{{ "%.0f"|format(stats.total_revenue) }}</h3>
          <small>Chiffre d'Affaires</small>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Filtres Avancés -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row align-items-end">
        <div class="col-md-2">
          <label class="form-label">Filtrer par Statut :</label>
          <select id="statusFilter" class="form-select">
            <option value="">Toutes les Commandes</option>
            <option value="pending">En Attente</option>
            <option value="processing">En Traitement</option>
            <option value="shipped">Expédiée</option>
            <option value="delivered">Livrée</option>
            <option value="completed">Terminée</option>
            <option value="cancelled">Annulée</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Mode de Paiement :</label>
          <select id="paymentFilter" class="form-select">
            <option value="">Tous</option>
            <option value="card">Carte Bancaire</option>
            <option value="cash_on_delivery">Paiement à la Livraison</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Type de Livraison :</label>
          <select id="deliveryFilter" class="form-select">
            <option value="">Tous</option>
            <option value="home_delivery">Livraison Standard</option>
            <option value="express_delivery">Livraison Express</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Rechercher Client :</label>
          <div class="input-group">
            <input type="text" id="customerSearch" class="form-control" placeholder="Nom, email, ville...">
            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label">Trier par :</label>
          <select id="sortOrder" class="form-select">
            <option value="date-desc">Plus Récentes</option>
            <option value="date-asc">Plus Anciennes</option>
            <option value="total-desc">Montant ↓</option>
            <option value="total-asc">Montant ↑</option>
            <option value="customer-asc">Client A-Z</option>
          </select>
        </div>
        <div class="col-md-2">
          <button type="button" class="btn btn-secondary w-100" onclick="clearAllFilters()">
            <i class="fas fa-undo"></i> Effacer
          </button>
          <small class="text-muted d-block mt-1">
            <span id="visibleCount">{{ orders.items|length if orders.items else 0 }}</span> 
            / <span id="totalCount">{{ orders.total if orders else 0 }}</span>
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Tableau des Commandes -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Toutes les Commandes</h5>
      <div class="d-flex gap-2 align-items-center">
        {% if orders and orders.items %}
        <div class="d-flex align-items-center me-3">
          <label for="ordersPerPage" class="me-2 mb-0">Par page:</label>
          <select id="ordersPerPage" class="form-select form-select-sm" style="width: auto;">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
        </div>
        {% endif %}
        <button class="btn btn-sm btn-outline-info" onclick="exportOrders()">
          <i class="fas fa-download"></i> Exporter
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="refreshOrders()">
          <i class="fas fa-sync-alt"></i> Actualiser
        </button>
      </div>
    </div>
    <div class="card-body p-0">
      {% if orders and orders.items %}
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th style="width: 50px;">
                <input type="checkbox" id="selectAll" class="form-check-input">
              </th>
              <th>Référence</th>
              <th>Client & Livraison</th>
              <th>Paiement & Livraison</th>
              <th>Date</th>
              <th>Total</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
            {% for order in orders.items %}
            <tr class="order-row" 
                data-status="{{ order.status }}" 
                data-customer="{{ order.user.username|lower }} {{ order.user.email|lower }} {{ order.details.customer_name|lower if order.details else '' }} {{ order.details.shipping_city|lower if order.details else '' }}"
                data-date="{{ order.created_at.strftime('%Y-%m-%d %H:%M:%S') }}"
                data-total="{{ order.total }}"
                data-payment="{{ order.details.payment_method if order.details else '' }}"
                data-delivery="{{ order.details.delivery_method if order.details else '' }}"
                data-order-id="{{ order.id }}">
              <td>
                <input type="checkbox" class="form-check-input order-checkbox" value="{{ order.id }}">
              </td>
              <td>
                <div class="d-flex flex-column">
                  <strong class="text-primary">{{ order.title }}</strong>
                  <small class="text-muted">#{{ order.id }}</small>
                </div>
              </td>
              <td>
                <div class="customer-info">
                  <div class="d-flex align-items-start">
                    <div class="me-2">
                      <i class="fas fa-user text-muted"></i>
                    </div>
                    <div>
                      <div class="fw-bold">
                        {{ order.details.customer_name if order.details else order.user.username }}
                      </div>
                      <small class="text-muted d-block">
                        {{ order.details.customer_email if order.details else order.user.email }}
                      </small>
                      {% if order.details and order.details.customer_phone %}
                      <small class="text-muted d-block">
                        <i class="fas fa-phone fa-xs me-1"></i>{{ order.details.customer_phone }}
                      </small>
                      {% endif %}
                      {% if order.details and order.details.shipping_city %}
                      <small class="text-primary d-block">
                        <i class="fas fa-map-marker-alt fa-xs me-1"></i>{{ order.details.shipping_city }}
                      </small>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </td>
              <td>
                <div class="payment-delivery-info">
                  {% if order.details %}
                  <div class="mb-1">
                    {% if order.details.payment_method == 'card' %}
                    <span class="badge bg-primary">
                      <i class="fas fa-credit-card me-1"></i>Carte
                    </span>
                    {% elif order.details.payment_method == 'cash_on_delivery' %}
                    <span class="badge bg-success">
                      <i class="fas fa-money-bill-wave me-1"></i>À la livraison
                    </span>
                    {% endif %}
                  </div>
                  <div>
                    {% if order.details.delivery_method == 'express_delivery' %}
                    <span class="badge bg-warning text-dark">
                      <i class="fas fa-shipping-fast me-1"></i>Express
                    </span>
                    {% elif order.details.delivery_method == 'home_delivery' %}
                    <span class="badge bg-info">
                      <i class="fas fa-home me-1"></i>Standard
                    </span>
                    {% endif %}
                  </div>
                  {% if order.details.shipping_cost > 0 %}
                  <small class="text-muted d-block mt-1">
                    Livraison: {{ "%.2f"|format(order.details.shipping_cost) }} DH
                  </small>
                  {% endif %}
                  {% else %}
                  <small class="text-muted">Données indisponibles</small>
                  {% endif %}
                </div>
              </td>
              <td>
                <div>
                  <div class="fw-bold">{{ order.created_at.strftime('%d %b %Y') }}</div>
                  <small class="text-muted">{{ order.created_at.strftime('%H:%M') }}</small>
                </div>
              </td>
              <td>
                <div class="text-end">
                  <div class="fw-bold text-success order-total">{{ "%.2f"|format(order.total) }} DH</div>
                  {% if order.details and order.details.shipping_cost > 0 %}
                  <small class="text-muted">
                    (dont {{ "%.2f"|format(order.details.shipping_cost) }} DH livraison)
                  </small>
                  {% endif %}
                </div>
              </td>
              <td>
                <span class="badge order-status bg-{{ 'warning' if order.status == 'pending' 
                                        else 'info' if order.status == 'processing' 
                                        else 'primary' if order.status == 'shipped' 
                                        else 'success' if order.status in ['delivered', 'completed'] 
                                        else 'danger' }}">
                  {% if order.status == 'pending' %}En Attente
                  {% elif order.status == 'processing' %}En Traitement
                  {% elif order.status == 'shipped' %}Expédiée
                  {% elif order.status == 'delivered' %}Livrée
                  {% elif order.status == 'completed' %}Terminée
                  {% elif order.status == 'cancelled' %}Annulée
                  {% else %}{{ order.status|title }}
                  {% endif %}
                </span>
              </td>
              <td>
                <div class="btn-group" role="group">
                  <!-- Bouton Voir Détails -->
                  <a href="{{ url_for('admin_order_detail', order_id=order.id) }}" 
                     class="btn btn-sm btn-outline-primary" title="Voir Détails">
                    <i class="fas fa-eye"></i>
                  </a>
                  
                  <!-- Bouton Info Client -->
                  {% if order.details %}
                  <button type="button" class="btn btn-sm btn-outline-info" 
                          data-bs-toggle="modal" 
                          data-bs-target="#customerInfoModal{{ order.id }}"
                          title="Infos Client">
                    <i class="fas fa-info-circle"></i>
                  </button>
                  {% endif %}
                  
                  <!-- Mise à Jour Rapide du Statut -->
                  <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                            data-bs-toggle="dropdown" 
                            aria-expanded="false"
                            data-bs-auto-close="true"
                            title="Changer Statut">
                      <i class="fas fa-edit"></i>
                    </button>
                    <ul class="dropdown-menu">
                      {% for status_key, status_label in [
                        ('pending', 'En Attente'),
                        ('processing', 'En Traitement'),
                        ('shipped', 'Expédiée'),
                        ('delivered', 'Livrée'),
                        ('completed', 'Terminée'),
                        ('cancelled', 'Annulée')
                      ] %}
                      <li>
                        <form method="POST" action="{{ url_for('update_order_status', order_id=order.id) }}" 
                              style="margin: 0;">
                          <input type="hidden" name="status" value="{{ status_key }}">
                          <button type="submit" 
                                  class="dropdown-item {{ 'active' if order.status == status_key else '' }}"
                                  onclick="return confirm('Changer le statut vers {{ status_label|lower }} ?')">
                            <i class="fas fa-{{ 'clock' if status_key == 'pending' 
                                           else 'cog' if status_key == 'processing'
                                           else 'shipping-fast' if status_key == 'shipped'
                                           else 'truck' if status_key == 'delivered'
                                           else 'check-circle' if status_key == 'completed'
                                           else 'times' }} me-2"></i>
                            {{ status_label }}
                          </button>
                        </form>
                      </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </td>
            </tr>
            
            <!-- Modal d'informations client pour chaque commande -->
            {% if order.details %}
            <div class="modal fade" id="customerInfoModal{{ order.id }}" tabindex="-1">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                      <i class="fas fa-user-circle me-2"></i>
                      Informations Détaillées - Commande {{ order.title }}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <div class="row">
                      <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">
                          <i class="fas fa-user text-primary me-2"></i>Informations Client
                        </h6>
                        <div class="mb-3">
                          <label class="form-label fw-bold">Nom Complet:</label>
                          <div>{{ order.details.customer_name }}</div>
                        </div>
                        <div class="mb-3">
                          <label class="form-label fw-bold">Email:</label>
                          <div>{{ order.details.customer_email }}</div>
                        </div>
                        <div class="mb-3">
                          <label class="form-label fw-bold">Téléphone:</label>
                          <div>{{ order.details.customer_phone }}</div>
                        </div>
                        
                        <h6 class="border-bottom pb-2 mb-3 mt-4">
                          <i class="fas fa-map-marker-alt text-primary me-2"></i>Adresse de Livraison
                        </h6>
                        <div class="mb-3">
                          <label class="form-label fw-bold">Adresse:</label>
                          <div class="text-break">{{ order.details.shipping_address }}</div>
                        </div>
                        <div class="row">
                          <div class="col-6">
                            <div class="mb-3">
                              <label class="form-label fw-bold">Ville:</label>
                              <div>{{ order.details.shipping_city }}</div>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="mb-3">
                              <label class="form-label fw-bold">Code Postal:</label>
                              <div>{{ order.details.shipping_postal or 'Non renseigné' }}</div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">
                          <i class="fas fa-credit-card text-primary me-2"></i>Paiement & Livraison
                        </h6>
                        <div class="mb-3">
                          <label class="form-label fw-bold">Mode de Paiement:</label>
                          <div>
                            {% if order.details.payment_method == 'card' %}
                            <span class="badge bg-primary">
                              <i class="fas fa-credit-card me-1"></i>Carte Bancaire
                            </span>
                            {% elif order.details.payment_method == 'cash_on_delivery' %}
                            <span class="badge bg-success">
                              <i class="fas fa-money-bill-wave me-1"></i>Paiement à la Livraison
                            </span>
                            {% endif %}
                          </div>
                        </div>
                        <div class="mb-3">
                          <label class="form-label fw-bold">Mode de Livraison:</label>
                          <div>
                            {% if order.details.delivery_method == 'express_delivery' %}
                            <span class="badge bg-warning text-dark">
                              <i class="fas fa-shipping-fast me-1"></i>Livraison Express (24-48h)
                            </span>
                            {% elif order.details.delivery_method == 'home_delivery' %}
                            <span class="badge bg-info">
                              <i class="fas fa-home me-1"></i>Livraison Standard (2-5 jours)
                            </span>
                            {% endif %}
                          </div>
                        </div>
                        <div class="mb-3">
                          <label class="form-label fw-bold">Coût de Livraison:</label>
                          <div class="fw-bold text-success">
                            {% if order.details.shipping_cost == 0 %}
                            GRATUITE
                            {% else %}
                            {{ "%.2f"|format(order.details.shipping_cost) }} DH
                            {% endif %}
                          </div>
                        </div>
                        
                        {% if order.details.special_instructions %}
                        <h6 class="border-bottom pb-2 mb-3 mt-4">
                          <i class="fas fa-comment text-primary me-2"></i>Instructions Spéciales
                        </h6>
                        <div class="alert alert-light">
                          <div class="text-break">{{ order.details.special_instructions }}</div>
                        </div>
                        {% endif %}
                        
                        <h6 class="border-bottom pb-2 mb-3 mt-4">
                          <i class="fas fa-calendar text-primary me-2"></i>Informations Commande
                        </h6>
                        <div class="mb-2">
                          <small><strong>Date de commande:</strong> {{ order.created_at.strftime('%d/%m/%Y à %H:%M') }}</small>
                        </div>
                        <div class="mb-2">
                          <small><strong>Statut actuel:</strong> 
                            <span class="badge bg-{{ 'warning' if order.status == 'pending' 
                                            else 'info' if order.status == 'processing' 
                                            else 'primary' if order.status == 'shipped' 
                                            else 'success' if order.status in ['delivered', 'completed'] 
                                            else 'danger' }}">
                              {% if order.status == 'pending' %}En Attente
                              {% elif order.status == 'processing' %}En Traitement
                              {% elif order.status == 'shipped' %}Expédiée
                              {% elif order.status == 'delivered' %}Livrée
                              {% elif order.status == 'completed' %}Terminée
                              {% elif order.status == 'cancelled' %}Annulée
                              {% endif %}
                            </span>
                          </small>
                        </div>
                        <div class="mb-2">
                          <small><strong>Total commande:</strong> <span class="fw-bold text-success">{{ "%.2f"|format(order.total) }} DH</span></small>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <a href="{{ url_for('admin_order_detail', order_id=order.id) }}" class="btn btn-primary">
                      Voir Détails Complets
                    </a>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}
            
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination Controls for Orders -->
      <div class="d-flex justify-content-between align-items-center mt-4 mx-3">
        <div id="ordersPaginationInfo" class="text-muted">
          <!-- Info will be populated by JavaScript -->
        </div>
        <nav aria-label="Orders pagination">
          <ul id="ordersPaginationControls" class="pagination pagination-sm mb-0">
            <!-- Pagination will be populated by JavaScript -->
          </ul>
        </nav>
      </div>

      <!-- Barre d'Actions en Lot -->
      <div class="card-footer d-none" id="bulkActionsBar">
        <div class="d-flex justify-content-between align-items-center">
          <span class="text-muted">
            <span id="selectedCount">0</span> commandes sélectionnées
          </span>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-info dropdown-toggle" 
                    type="button"
                    data-bs-toggle="dropdown" 
                    aria-expanded="false"
                    data-bs-auto-close="true">
              Actions en Lot
            </button>
            <ul class="dropdown-menu">
              <li><button type="button" class="dropdown-item" onclick="bulkUpdateStatus('processing')">
                <i class="fas fa-cog me-2"></i>Mettre en Traitement
              </button></li>
              <li><button type="button" class="dropdown-item" onclick="bulkUpdateStatus('shipped')">
                <i class="fas fa-shipping-fast me-2"></i>Marquer comme Expédiées
              </button></li>
              <li><button type="button" class="dropdown-item" onclick="bulkUpdateStatus('completed')">
                <i class="fas fa-check-circle me-2"></i>Marquer comme Terminées
              </button></li>
              <li><hr class="dropdown-divider"></li>
              <li><button type="button" class="dropdown-item text-danger" onclick="bulkDelete()">
                <i class="fas fa-trash me-2"></i>Supprimer Sélectionnées
              </button></li>
            </ul>
          </div>
        </div>
      </div>

      {% else %}
      <!-- Aucune Commande Trouvée -->
      <div class="text-center py-5" id="noOrdersMessage">
        <div class="mb-3">
          <i class="fas fa-inbox fa-3x text-muted"></i>
        </div>
        <h5 class="text-muted">Aucune Commande Trouvée</h5>
        <p class="text-muted mb-3">
          Aucune commande ne correspond aux filtres actuels.
        </p>
        <div>
          <button class="btn btn-primary" onclick="clearAllFilters()">
            <i class="fas fa-undo"></i> Effacer les Filtres
          </button>
          <a href="{{ url_for('create_test_order') }}" class="btn btn-success">
            <i class="fas fa-plus"></i> Créer Commande Test
          </a>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Informations de Debug (À supprimer en production) -->
  <div class="mt-4">
    <div class="card border-info">
      <div class="card-header bg-info text-white">
        <h6 class="mb-0">Informations de Debug</h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <small>
              <strong>Utilisateur Actuel :</strong> {{ current_user.username }}<br>
              <strong>Est Admin :</strong> {{ current_user.is_admin }}<br>
              <strong>Total Commandes en BDD :</strong> {{ stats.total_orders if stats else 'N/A' }}
            </small>
          </div>
          <div class="col-md-6">
            <small>
              <strong>Filtre Appliqué :</strong> <span id="debugCurrentFilter">Aucun</span><br>
              <strong>Commandes Récupérées :</strong> {{ orders.items|length if orders and orders.items else 0 }}<br>
              <strong>Page Actuelle :</strong> {{ orders.page if orders else 1 }}
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Orders Pagination Class (keeping existing pagination logic)
class AdminOrdersPagination {
  constructor() {
    this.currentPage = 1;
    this.itemsPerPage = 10;
    this.allRows = [];
    this.filteredRows = [];
    this.init();
  }

  init() {
    this.allRows = Array.from(document.querySelectorAll('.order-row'));
    this.filteredRows = [...this.allRows];
    
    if (this.allRows.length === 0) return;

    const itemsSelect = document.getElementById('ordersPerPage');
    if (itemsSelect) {
      const savedItemsPerPage = localStorage.getItem('adminOrdersPerPage');
      if (savedItemsPerPage) {
        this.itemsPerPage = parseInt(savedItemsPerPage);
        itemsSelect.value = this.itemsPerPage;
      }

      itemsSelect.addEventListener('change', (e) => {
        this.itemsPerPage = parseInt(e.target.value);
        this.currentPage = 1;
        localStorage.setItem('adminOrdersPerPage', this.itemsPerPage);
        this.updateDisplay();
      });
    }

    this.updateDisplay();
  }

  setFilteredRows(rows) {
    this.filteredRows = rows;
    this.currentPage = 1;
    this.updateDisplay();
  }

  updateDisplay() {
    const totalItems = this.filteredRows.length;
    const totalPages = Math.ceil(totalItems / this.itemsPerPage);

    this.allRows.forEach(row => row.style.display = 'none');

    const startIndex = (this.currentPage - 1) * this.itemsPerPage;
    const endIndex = Math.min(startIndex + this.itemsPerPage, totalItems);

    for (let i = startIndex; i < endIndex; i++) {
      if (this.filteredRows[i]) {
        this.filteredRows[i].style.display = '';
      }
    }

    this.updatePaginationInfo(startIndex + 1, endIndex, totalItems);
    this.updatePaginationControls(totalPages);
  }

  updatePaginationInfo(start, end, total) {
    const infoElement = document.getElementById('ordersPaginationInfo');
    if (total === 0) {
      infoElement.textContent = 'Aucune commande à afficher';
    } else {
      infoElement.textContent = `Affichage de ${start} à ${end} sur ${total} commandes`;
    }
  }

  updatePaginationControls(totalPages) {
    const controls = document.getElementById('ordersPaginationControls');
    controls.innerHTML = '';

    if (totalPages < 1) return;

    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${this.currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Précédent"><span aria-hidden="true">&laquo;</span></a>`;
    if (this.currentPage > 1) {
      prevLi.querySelector('a').addEventListener('click', (e) => {
        e.preventDefault();
        this.goToPage(this.currentPage - 1);
      });
    }
    controls.appendChild(prevLi);

    // Page numbers
    if (totalPages > 1) {
      const maxVisiblePages = 5;
      let startPage = Math.max(1, this.currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      if (startPage > 1) {
        this.createPageButton(controls, 1);
        if (startPage > 2) {
          const ellipsis = document.createElement('li');
          ellipsis.className = 'page-item disabled';
          ellipsis.innerHTML = '<span class="page-link">...</span>';
          controls.appendChild(ellipsis);
        }
      }

      for (let i = startPage; i <= endPage; i++) {
        this.createPageButton(controls, i);
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const ellipsis = document.createElement('li');
          ellipsis.className = 'page-item disabled';
          ellipsis.innerHTML = '<span class="page-link">...</span>';
          controls.appendChild(ellipsis);
        }
        this.createPageButton(controls, totalPages);
      }
    } else {
      this.createPageButton(controls, 1);
    }

    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${this.currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Suivant"><span aria-hidden="true">&raquo;</span></a>`;
    if (this.currentPage < totalPages) {
      nextLi.querySelector('a').addEventListener('click', (e) => {
        e.preventDefault();
        this.goToPage(this.currentPage + 1);
      });
    }
    controls.appendChild(nextLi);
  }

  createPageButton(container, pageNumber) {
    const li = document.createElement('li');
    li.className = `page-item ${pageNumber === this.currentPage ? 'active' : ''}`;
    const link = document.createElement('a');
    link.className = 'page-link';
    link.href = '#';
    link.textContent = pageNumber;
    
    if (pageNumber === this.currentPage) {
      link.style.backgroundColor = '#2587b1';
      link.style.borderColor = '#2587b1';
      link.style.color = '#ffffff';
    }
    
    li.appendChild(link);
    
    if (pageNumber !== this.currentPage) {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        this.goToPage(pageNumber);
      });
    }
    
    container.appendChild(li);
  }

  goToPage(page) {
    this.currentPage = page;
    this.updateDisplay();
  }
}

// Global pagination instance
let ordersPagination;

// Initialize Bootstrap dropdowns
function initializeDropdowns() {
    // Initialize all dropdown toggles
    const dropdownElementList = document.querySelectorAll('[data-bs-toggle="dropdown"]');
    dropdownElementList.forEach(function (dropdownToggleEl) {
        if (!dropdownToggleEl.hasAttribute('data-bs-initialized')) {
            new bootstrap.Dropdown(dropdownToggleEl);
            dropdownToggleEl.setAttribute('data-bs-initialized', 'true');
        }
    });
}

// Fix dropdown positioning in table
function fixDropdownPositioning() {
    document.addEventListener('show.bs.dropdown', function (event) {
        const dropdown = event.target;
        const menu = dropdown.nextElementSibling;
        
        if (menu && menu.classList.contains('dropdown-menu')) {
            // Get viewport dimensions
            const viewport = {
                width: window.innerWidth || document.documentElement.clientWidth,
                height: window.innerHeight || document.documentElement.clientHeight
            };
            
            // Get dropdown position
            const rect = dropdown.getBoundingClientRect();
            
            // Check if dropdown would go off screen and adjust
            if (rect.left + 200 > viewport.width) {
                menu.classList.add('dropdown-menu-end');
            }
            
            if (rect.top + 200 > viewport.height) {
                menu.classList.add('dropup');
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize pagination
    setTimeout(() => {
        ordersPagination = new AdminOrdersPagination();
    }, 100);

    // Get filter elements
    const statusFilter = document.getElementById('statusFilter');
    const customerSearch = document.getElementById('customerSearch');
    const sortOrder = document.getElementById('sortOrder');
    const paymentFilter = document.getElementById('paymentFilter');
    const deliveryFilter = document.getElementById('deliveryFilter');
    const selectAll = document.getElementById('selectAll');
    
    // Get display elements
    const visibleCount = document.getElementById('visibleCount');
    const totalCount = document.getElementById('totalCount');
    const debugCurrentFilter = document.getElementById('debugCurrentFilter');
    const noOrdersMessage = document.getElementById('noOrdersMessage');
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const selectedCount = document.getElementById('selectedCount');
    
    // Get all order rows
    const orderRows = document.querySelectorAll('.order-row');
    const totalOrders = orderRows.length;
    
    // Event listeners
    statusFilter.addEventListener('change', filterOrders);
    customerSearch.addEventListener('input', debounce(filterOrders, 300));
    sortOrder.addEventListener('change', filterOrders);
    paymentFilter.addEventListener('change', filterOrders);
    deliveryFilter.addEventListener('change', filterOrders);
    selectAll.addEventListener('change', toggleSelectAll);
    
    // Add listeners to individual checkboxes
    document.querySelectorAll('.order-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActions);
    });
    
    function filterOrders() {
        const statusValue = statusFilter.value.toLowerCase();
        const searchValue = customerSearch.value.toLowerCase().trim();
        const sortValue = sortOrder.value;
        const paymentValue = paymentFilter.value.toLowerCase();
        const deliveryValue = deliveryFilter.value.toLowerCase();
        
        let visibleOrders = [];
        let filteredOrders = Array.from(orderRows);
        
        // Filter by status
        if (statusValue) {
            filteredOrders = filteredOrders.filter(row => {
                return row.dataset.status === statusValue;
            });
        }
        
        // Filter by payment method
        if (paymentValue) {
            filteredOrders = filteredOrders.filter(row => {
                return row.dataset.payment === paymentValue;
            });
        }
        
        // Filter by delivery method
        if (deliveryValue) {
            filteredOrders = filteredOrders.filter(row => {
                return row.dataset.delivery === deliveryValue;
            });
        }
        
        // Filter by customer search (name, email, phone, city)
        if (searchValue) {
            filteredOrders = filteredOrders.filter(row => {
                return row.dataset.customer.includes(searchValue);
            });
        }
        
        // Sort orders
        filteredOrders.sort((a, b) => {
            switch(sortValue) {
                case 'date-desc':
                    return new Date(b.dataset.date) - new Date(a.dataset.date);
                case 'date-asc':
                    return new Date(a.dataset.date) - new Date(b.dataset.date);
                case 'total-desc':
                    return parseFloat(b.dataset.total) - parseFloat(a.dataset.total);
                case 'total-asc':
                    return parseFloat(a.dataset.total) - parseFloat(b.dataset.total);
                case 'customer-asc':
                    return a.dataset.customer.localeCompare(b.dataset.customer);
                default:
                    return 0;
            }
        });
        
        // Update pagination with filtered results
        if (ordersPagination) {
            ordersPagination.setFilteredRows(filteredOrders);
        }
        
        // Reorder visible rows in table
        const tableBody = document.getElementById('ordersTableBody');
        filteredOrders.forEach(row => {
            tableBody.appendChild(row);
        });
        
        visibleOrders = filteredOrders;
        
        // Uncheck hidden rows
        orderRows.forEach(row => {
            if (!filteredOrders.includes(row)) {
                const checkbox = row.querySelector('.order-checkbox');
                if (checkbox) checkbox.checked = false;
            }
        });
        
        // Update counters
        visibleCount.textContent = visibleOrders.length;
        
        // Update debug info
        const filters = [];
        if (statusValue) filters.push(`Statut: ${statusValue}`);
        if (paymentValue) filters.push(`Paiement: ${paymentValue}`);
        if (deliveryValue) filters.push(`Livraison: ${deliveryValue}`);
        if (searchValue) filters.push(`Recherche: "${searchValue}"`);
        debugCurrentFilter.textContent = filters.length > 0 ? filters.join(', ') : 'Aucun';
        
        // Show/hide no orders message
        const hasVisibleOrders = visibleOrders.length > 0;
        const tableContainer = document.querySelector('.table-responsive');
        if (tableContainer) {
            tableContainer.style.display = hasVisibleOrders ? '' : 'none';
        }
        
        // Update statistics
        updateStatistics(filteredOrders);
        
        // Update bulk actions
        updateBulkActions();
        
        // IMPORTANT: Reinitialize dropdowns after filtering
        reinitializeDropdowns();
    }
    
    function updateStatistics(visibleOrders) {
        const stats = {
            total: visibleOrders.length,
            pending: 0,
            processing: 0,
            revenue: 0
        };
        
        visibleOrders.forEach(row => {
            const status = row.dataset.status;
            const total = parseFloat(row.dataset.total);
            
            if (status === 'pending') stats.pending++;
            if (status === 'processing') stats.processing++;
            if (status === 'completed') stats.revenue += total;
        });
        
        // Update stat cards
        const totalOrdersCount = document.getElementById('totalOrdersCount');
        const pendingOrdersCount = document.getElementById('pendingOrdersCount');
        const processingOrdersCount = document.getElementById('processingOrdersCount');
        const totalRevenueCount = document.getElementById('totalRevenueCount');
        
        if (totalOrdersCount) totalOrdersCount.textContent = stats.total;
        if (pendingOrdersCount) pendingOrdersCount.textContent = stats.pending;
        if (processingOrdersCount) processingOrdersCount.textContent = stats.processing;
        if (totalRevenueCount) totalRevenueCount.textContent = `DH${Math.round(stats.revenue)}`;
    }
    
    function toggleSelectAll() {
        const visibleCheckboxes = Array.from(document.querySelectorAll('.order-checkbox'))
            .filter(cb => cb.closest('.order-row').style.display !== 'none');
        
        visibleCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateBulkActions();
    }
    
    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
        const count = checkedBoxes.length;
        
        selectedCount.textContent = count;
        
        if (count > 0) {
            bulkActionsBar.classList.remove('d-none');
        } else {
            bulkActionsBar.classList.add('d-none');
        }
        
        // Update select all checkbox
        const visibleCheckboxes = Array.from(document.querySelectorAll('.order-checkbox'))
            .filter(cb => cb.closest('.order-row').style.display !== 'none');
        const allChecked = visibleCheckboxes.length > 0 && visibleCheckboxes.every(cb => cb.checked);
        const someChecked = visibleCheckboxes.some(cb => cb.checked);
        
        selectAll.checked = allChecked;
        selectAll.indeterminate = someChecked && !allChecked;
    }
    
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Global functions
    window.clearSearch = function() {
        customerSearch.value = '';
        filterOrders();
    };
    
    window.clearAllFilters = function() {
        statusFilter.value = '';
        customerSearch.value = '';
        sortOrder.value = 'date-desc';
        paymentFilter.value = '';
        deliveryFilter.value = '';
        selectAll.checked = false;
        document.querySelectorAll('.order-checkbox:checked').forEach(cb => cb.checked = false);
        filterOrders();
    };
    
    window.refreshOrders = function() {
        location.reload();
    };
    
    window.exportOrders = function() {
        const visibleOrders = Array.from(orderRows).filter(row => row.style.display !== 'none');
        const data = visibleOrders.map(row => {
            const customerInfo = row.querySelector('.customer-info');
            const paymentDeliveryInfo = row.querySelector('.payment-delivery-info');
            
            return {
                reference: row.querySelector('strong').textContent,
                client: customerInfo.querySelector('.fw-bold').textContent,
                email: customerInfo.querySelector('small').textContent,
                phone: customerInfo.querySelector('.fa-phone') ? 
                       customerInfo.querySelector('.fa-phone').parentNode.textContent.replace(/[\s\n]+/g, ' ').trim() : '',
                city: customerInfo.querySelector('.fa-map-marker-alt') ? 
                      customerInfo.querySelector('.fa-map-marker-alt').parentNode.textContent.replace(/[\s\n]+/g, ' ').trim() : '',
                payment: row.dataset.payment || '',
                delivery: row.dataset.delivery || '',
                date: row.dataset.date,
                total: row.dataset.total,
                statut: row.querySelector('.order-status').textContent
            };
        });
        
        const csv = [
            ['Référence', 'Client', 'Email', 'Téléphone', 'Ville', 'Paiement', 'Livraison', 'Date', 'Total', 'Statut'],
            ...data.map(order => [
                order.reference, order.client, order.email, order.phone, order.city, 
                order.payment, order.delivery, order.date, order.total, order.statut
            ])
        ].map(row => row.join(',')).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `commandes-detaillees-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    };
    
    window.bulkUpdateStatus = function(newStatus) {
        const selectedOrders = Array.from(document.querySelectorAll('.order-checkbox:checked'));
        if (selectedOrders.length === 0) return;
        
        const statusLabels = {
            'processing': 'en traitement',
            'shipped': 'expédiées',
            'completed': 'terminées'
        };
        
        if (confirm(`Mettre à jour ${selectedOrders.length} commandes vers ${statusLabels[newStatus]} ?`)) {
            selectedOrders.forEach(checkbox => {
                const orderId = checkbox.value;
                const row = checkbox.closest('.order-row');
                
                // Update display immediately
                row.dataset.status = newStatus;
                const statusBadge = row.querySelector('.order-status');
                
                const statusDisplayNames = {
                    'processing': 'En Traitement',
                    'shipped': 'Expédiée',
                    'completed': 'Terminée'
                };
                
                statusBadge.textContent = statusDisplayNames[newStatus];
                statusBadge.className = `badge order-status bg-${getStatusColor(newStatus)}`;
                
                // Send update to server (implement this)
                // fetch(`/admin/orders/${orderId}/update_status`, {...})
            });
            
            filterOrders();
        }
    };
    
    window.bulkDelete = function() {
        const selectedOrders = Array.from(document.querySelectorAll('.order-checkbox:checked'));
        if (selectedOrders.length === 0) return;
        
        if (confirm(`Supprimer ${selectedOrders.length} commandes ? Cette action ne peut pas être annulée.`)) {
            selectedOrders.forEach(checkbox => {
                const row = checkbox.closest('.order-row');
                row.remove();
            });
            
            filterOrders();
        }
    };
    
    function getStatusColor(status) {
        switch(status) {
            case 'pending': return 'warning';
            case 'processing': return 'info';
            case 'shipped': return 'primary';
            case 'delivered':
            case 'completed': return 'success';
            case 'cancelled': return 'danger';
            default: return 'secondary';
        }
    }
});

// FIX: Reinitialize Bootstrap dropdowns after DOM manipulation
function reinitializeDropdowns() {
    // Wait for any DOM manipulation to complete
    setTimeout(() => {
        document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(element => {
            // Only initialize if not already initialized
            if (!bootstrap.Dropdown.getInstance(element)) {
                try {
                    new bootstrap.Dropdown(element);
                } catch (e) {
                    console.warn('Failed to initialize dropdown:', e);
                }
            }
        });
    }, 100);
}

// Initialize pagination when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        if (!ordersPagination) {
            ordersPagination = new AdminOrdersPagination();
        }
        // Reinitialize dropdowns after pagination setup
        reinitializeDropdowns();
    }, 200);
});

// Also initialize if window is already loaded
if (document.readyState === 'complete') {
    setTimeout(() => {
        if (!ordersPagination) {
            ordersPagination = new AdminOrdersPagination();
        }
        // Reinitialize dropdowns after pagination setup
        reinitializeDropdowns();
    }, 200);
}
</script>

<style>
.btn-group .dropdown-menu {
  min-width: 150px;
}

.dropdown-item.active {
  background-color: #0d6efd;
  color: white;
}

.order-row {
  transition: all 0.3s ease;
}

.table-responsive {
  transition: opacity 0.3s ease;
}

#bulkActionsBar {
  background-color: #f8f9fa;
  border-top: 1px solid #dee2e6;
}

.customer-info {
  min-width: 200px;
}

.payment-delivery-info {
  min-width: 120px;
}

.badge {
  font-size: 0.75em;
}

.modal-body .form-label {
  font-size: 0.9em;
  margin-bottom: 0.25rem;
}

.modal-body > div > div {
  margin-bottom: 0.5rem;
}

@media (max-width: 768px) {
  .btn-group {
    display: block;
  }
  
  .btn-group .btn {
    display: block;
    width: 100%;
    margin-bottom: 2px;
  }
  
  .card-body .row > div {
    margin-bottom: 1rem;
  }
  
  .customer-info, .payment-delivery-info {
    min-width: auto;
  }
  
  .table th, .table td {
    padding: 0.5rem 0.25rem;
    font-size: 0.85em;
  }
}
</style>
{% endblock %}