{% for product in products %}
{% set review_stats = get_product_review_stats(product.id) %}
<div class="col-lg-3 col-md-6 mb-4 product-item">
    <div class="card h-100 shadow-sm product-card"
         onclick="navigateToProduct('{{ url_for('product_detail', product_id=product.id) }}')">
     
      <!-- Image -->
      <div class="card-img-container position-relative h-100">
        <img src="{{ product.image_url }}"
             class="card-img-top"
             alt="{{ product.name }}"
             loading="lazy" />
 
        <!-- Review Stars -->
        {% if review_stats.count > 0 %}
        <div class="review-badge position-absolute top-0 end-0 m-2">
          <span class="star-rating-display">
            {% for i in range(1, 6) %}
              {% if i <= review_stats.avg_rating %}
                <i class="fas fa-star text-warning"></i>
              {% elif i - 0.5 <= review_stats.avg_rating %}
                <i class="fas fa-star-half-alt text-warning"></i>
              {% else %}
                <i class="far fa-star text-warning"></i>
              {% endif %}
            {% endfor %}
          </span>
        </div>
        {% endif %}
 
        <!-- Overlay (détails produits cachés par défaut) -->
        <div class="product-overlay d-flex flex-column">
          <h6 class="fw-bold text-white">{{ product.name }}</h6>
          <p class="small">{{ product.description[:80] }}...</p>
          <span class="fw-bold text-white">{{ "%.2f"|format(product.price) }} DH</span>
          <div class="mt-2">
            <button class="btn btn-sm btn-light me-2"
                    onclick="event.stopPropagation(); navigateToProduct('{{ url_for('product_detail', product_id=product.id) }}');">
              <i class="fas fa-eye"></i>
            </button>
            {% if current_user.is_authenticated and product.stock > 0 %}
            <a href="{{ url_for('add_to_cart', product_id=product.id) }}"
               class="btn btn-sm"
               style="background-color: #127ca9; color: white;"
               onclick="event.stopPropagation();">
              <i class="fas fa-cart-plus"></i>
            </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
 
 
{% endfor %}

<style>
.card-img-container {
  position: relative;
  overflow: hidden;
  height: 100%;
  background-color: #2c2c2c;
}

.card-img-container img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: center;
  display: block;
}

.product-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  color: white;
  padding: 15px;
  opacity: 0;
  transition: opacity 0.3s ease;
  justify-content: center;
  text-align: center;
}

.product-card:hover .product-overlay {
  opacity: 1;
}

.product-card:hover .review-badge {
  display: none;
}

.product-card {
  cursor: pointer;
  transition: transform 0.3s ease;
}

.product-card:hover {
  transform: translateY(-5px);
}
</style>