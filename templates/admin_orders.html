{% extends "base.html" %}
{% block title %}Admin - All Orders Management{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>Orders Management</h2>
      <p class="text-muted mb-0">Manage all customer orders across the platform</p>
    </div>
    <div>
      <a href="{{ url_for('admin_products') }}" class="btn btn-outline-primary me-2">
        Manage Products
      </a>
      <a href="{{ url_for('create_test_order') }}" class="btn btn-success">
        Create Test Order
      </a>
    </div>
  </div>

  <!-- Statistics Cards -->
  {% if stats %}
  <div class="row mb-4" id="statsCards">
    <div class="col-md-3">
      <div class="card text-center bg-primary text-white">
        <div class="card-body">
          <h3 class="mb-0" id="totalOrdersCount">{{ stats.total_orders }}</h3>
          <small>Total Orders</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center bg-warning text-white">
        <div class="card-body">
          <h3 class="mb-0" id="pendingOrdersCount">{{ stats.pending_orders }}</h3>
          <small>Pending Orders</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center bg-info text-white">
        <div class="card-body">
          <h3 class="mb-0" id="processingOrdersCount">{{ stats.processing_orders }}</h3>
          <small>Processing</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center bg-success text-white">
        <div class="card-body">
          <h3 class="mb-0" id="totalRevenueCount">DH{{ "%.0f"|format(stats.total_revenue) }}</h3>
          <small>Total Revenue</small>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Enhanced Filters -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row align-items-end">
        <div class="col-md-3">
          <label class="form-label">Filter by Status:</label>
          <select id="statusFilter" class="form-select">
            <option value="">All Orders</option>
            <option value="pending">Pending</option>
            <option value="processing">Processing</option>
            <option value="shipped">Shipped</option>
            <option value="delivered">Delivered</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Search Customer:</label>
          <div class="input-group">
            <input type="text" id="customerSearch" class="form-control" placeholder="Username or email...">
            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label">Sort by:</label>
          <select id="sortOrder" class="form-select">
            <option value="date-desc">Newest First</option>
            <option value="date-asc">Oldest First</option>
            <option value="total-desc">Highest Amount</option>
            <option value="total-asc">Lowest Amount</option>
            <option value="customer-asc">Customer A-Z</option>
          </select>
        </div>
        <div class="col-md-2">
          <button type="button" class="btn btn-secondary w-100" onclick="clearAllFilters()">
            <i class="fas fa-undo"></i> Clear All
          </button>
        </div>
        <div class="col-md-2 text-end">
          <small class="text-muted">
            Showing <span id="visibleCount">{{ orders.items|length if orders.items else 0 }}</span> 
            of <span id="totalCount">{{ orders.total if orders else 0 }}</span> orders
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">All Orders</h5>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-info" onclick="exportOrders()">
          <i class="fas fa-download"></i> Export
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="refreshOrders()">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>
    </div>
    <div class="card-body p-0">
      {% if orders and orders.items %}
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>
                <input type="checkbox" id="selectAll" class="form-check-input"> 
                Order ID
              </th>
              <th>Customer</th>
              <th>Date</th>
              <th>Total</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
            {% for order in orders.items %}
            <tr class="order-row" 
                data-status="{{ order.status }}" 
                data-customer="{{ order.user.username|lower }} {{ order.user.email|lower }}"
                data-date="{{ order.created_at.strftime('%Y-%m-%d %H:%M:%S') }}"
                data-total="{{ order.total }}"
                data-order-id="{{ order.id }}">
              <td>
                <div class="d-flex align-items-center">
                  <input type="checkbox" class="form-check-input me-2 order-checkbox" value="{{ order.id }}">
                  <strong>#{{ order.id }}</strong>
                </div>
              </td>
              <td>
                <div class="customer-info">
                  <strong>{{ order.user.username }}</strong>
                  <br>
                  <small class="text-muted">{{ order.user.email }}</small>
                </div>
              </td>
              <td>
                <div>
                  {{ order.created_at.strftime('%b %d, %Y') }}
                  <br>
                  <small class="text-muted">{{ order.created_at.strftime('%I:%M %p') }}</small>
                </div>
              </td>
              <td>
                <strong class="text-success order-total">DH{{ "%.2f"|format(order.total) }}</strong>
              </td>
              <td>
                <span class="badge order-status bg-{{ 'warning' if order.status == 'pending' 
                                        else 'info' if order.status == 'processing' 
                                        else 'primary' if order.status == 'shipped' 
                                        else 'success' if order.status in ['delivered', 'completed'] 
                                        else 'danger' }}">
                  {{ order.status|title }}
                </span>
              </td>
              <td>
                <div class="btn-group" role="group">
                  <!-- View Details Button -->
                  <a href="{{ url_for('admin_order_detail', order_id=order.id) }}" 
                     class="btn btn-sm btn-outline-primary" title="View Details">
                    <i class="fas fa-eye"></i>
                  </a>
                  
                  <!-- Debug View Button -->
                  <a href="{{ url_for('debug_order_detail', order_id=order.id) }}" 
                     class="btn btn-sm btn-outline-info" title="Debug View">
                    <i class="fas fa-bug"></i>
                  </a>
                  
                  <!-- Quick Status Update -->
                  <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                            data-bs-toggle="dropdown">
                      <i class="fas fa-edit"></i>
                    </button>
                    <ul class="dropdown-menu">
                      {% for status in ['pending', 'processing', 'shipped', 'delivered', 'completed', 'cancelled'] %}
                      <li>
                        <form method="POST" action="{{ url_for('update_order_status', order_id=order.id) }}" 
                              style="display: inline;" onsubmit="handleStatusUpdate(event, {{ order.id }}, '{{ status }}')">
                          <input type="hidden" name="status" value="{{ status }}">
                          <button type="submit" class="dropdown-item {{ 'active' if order.status == status else '' }}"
                                  onclick="return confirm('Change status to {{ status }}?')">
                            <i class="fas fa-{{ 'clock' if status == 'pending' 
                                           else 'cog' if status == 'processing'
                                           else 'shipping-fast' if status == 'shipped'
                                           else 'truck' if status == 'delivered'
                                           else 'check-circle' if status == 'completed'
                                           else 'times' }} me-2"></i>
                            {{ status|title }}
                          </button>
                        </form>
                      </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Bulk Actions Bar -->
      <div class="card-footer d-none" id="bulkActionsBar">
        <div class="d-flex justify-content-between align-items-center">
          <span class="text-muted">
            <span id="selectedCount">0</span> orders selected
          </span>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">
              Bulk Actions
            </button>
            <ul class="dropdown-menu">
              <li><button class="dropdown-item" onclick="bulkUpdateStatus('processing')">
                <i class="fas fa-cog me-2"></i>Set to Processing
              </button></li>
              <li><button class="dropdown-item" onclick="bulkUpdateStatus('shipped')">
                <i class="fas fa-shipping-fast me-2"></i>Set to Shipped
              </button></li>
              <li><button class="dropdown-item" onclick="bulkUpdateStatus('completed')">
                <i class="fas fa-check-circle me-2"></i>Set to Completed
              </button></li>
              <li><hr class="dropdown-divider"></li>
              <li><button class="dropdown-item text-danger" onclick="bulkDelete()">
                <i class="fas fa-trash me-2"></i>Delete Selected
              </button></li>
            </ul>
          </div>
        </div>
      </div>

      {% else %}
      <!-- No Orders Found -->
      <div class="text-center py-5" id="noOrdersMessage">
        <div class="mb-3">
          <i class="fas fa-inbox fa-3x text-muted"></i>
        </div>
        <h5 class="text-muted">No Orders Found</h5>
        <p class="text-muted mb-3">
          No orders match your current filters.
        </p>
        <div>
          <button class="btn btn-primary" onclick="clearAllFilters()">
            <i class="fas fa-undo"></i> Clear Filters
          </button>
          <a href="{{ url_for('create_test_order') }}" class="btn btn-success">
            <i class="fas fa-plus"></i> Create Test Order
          </a>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Debug Information (Remove in production) -->
  <div class="mt-4">
    <div class="card border-info">
      <div class="card-header bg-info text-white">
        <h6 class="mb-0">Debug Information</h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <small>
              <strong>Current User:</strong> {{ current_user.username }}<br>
              <strong>Is Admin:</strong> {{ current_user.is_admin }}<br>
              <strong>Total Orders in DB:</strong> {{ stats.total_orders if stats else 'N/A' }}
            </small>
          </div>
          <div class="col-md-6">
            <small>
              <strong>Filter Applied:</strong> <span id="debugCurrentFilter">None</span><br>
              <strong>Orders Retrieved:</strong> {{ orders.items|length if orders and orders.items else 0 }}<br>
              <strong>Current Page:</strong> {{ orders.page if orders else 1 }}
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get filter elements
    const statusFilter = document.getElementById('statusFilter');
    const customerSearch = document.getElementById('customerSearch');
    const sortOrder = document.getElementById('sortOrder');
    const selectAll = document.getElementById('selectAll');
    
    // Get display elements
    const visibleCount = document.getElementById('visibleCount');
    const totalCount = document.getElementById('totalCount');
    const debugCurrentFilter = document.getElementById('debugCurrentFilter');
    const noOrdersMessage = document.getElementById('noOrdersMessage');
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const selectedCount = document.getElementById('selectedCount');
    
    // Get all order rows
    const orderRows = document.querySelectorAll('.order-row');
    const totalOrders = orderRows.length;
    
    // Event listeners
    statusFilter.addEventListener('change', filterOrders);
    customerSearch.addEventListener('input', debounce(filterOrders, 300));
    sortOrder.addEventListener('change', filterOrders);
    selectAll.addEventListener('change', toggleSelectAll);
    
    // Add event listeners to individual checkboxes
    document.querySelectorAll('.order-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActions);
    });
    
    function filterOrders() {
        const statusValue = statusFilter.value.toLowerCase();
        const searchValue = customerSearch.value.toLowerCase().trim();
        const sortValue = sortOrder.value;
        
        let visibleOrders = [];
        let filteredOrders = Array.from(orderRows);
        
        // Filter by status
        if (statusValue) {
            filteredOrders = filteredOrders.filter(row => {
                return row.dataset.status === statusValue;
            });
        }
        
        // Filter by customer search
        if (searchValue) {
            filteredOrders = filteredOrders.filter(row => {
                return row.dataset.customer.includes(searchValue);
            });
        }
        
        // Sort orders
        filteredOrders.sort((a, b) => {
            switch(sortValue) {
                case 'date-desc':
                    return new Date(b.dataset.date) - new Date(a.dataset.date);
                case 'date-asc':
                    return new Date(a.dataset.date) - new Date(b.dataset.date);
                case 'total-desc':
                    return parseFloat(b.dataset.total) - parseFloat(a.dataset.total);
                case 'total-asc':
                    return parseFloat(a.dataset.total) - parseFloat(b.dataset.total);
                case 'customer-asc':
                    return a.dataset.customer.localeCompare(b.dataset.customer);
                default:
                    return 0;
            }
        });
        
        // Show/hide orders
        orderRows.forEach(row => {
            if (filteredOrders.includes(row)) {
                row.style.display = '';
                visibleOrders.push(row);
            } else {
                row.style.display = 'none';
                // Uncheck hidden checkboxes
                const checkbox = row.querySelector('.order-checkbox');
                if (checkbox) checkbox.checked = false;
            }
        });
        
        // Reorder visible rows in the table
        const tableBody = document.getElementById('ordersTableBody');
        filteredOrders.forEach(row => {
            tableBody.appendChild(row);
        });
        
        // Update counts
        visibleCount.textContent = visibleOrders.length;
        
        // Update debug info
        const filters = [];
        if (statusValue) filters.push(`Status: ${statusValue}`);
        if (searchValue) filters.push(`Search: "${searchValue}"`);
        debugCurrentFilter.textContent = filters.length > 0 ? filters.join(', ') : 'None';
        
        // Show/hide no orders message
        const hasVisibleOrders = visibleOrders.length > 0;
        const tableContainer = document.querySelector('.table-responsive');
        if (tableContainer) {
            tableContainer.style.display = hasVisibleOrders ? '' : 'none';
        }
        
        // Update statistics cards
        updateStatistics(filteredOrders);
        
        // Update bulk actions
        updateBulkActions();
    }
    
    function updateStatistics(visibleOrders) {
        const stats = {
            total: visibleOrders.length,
            pending: 0,
            processing: 0,
            revenue: 0
        };
        
        visibleOrders.forEach(row => {
            const status = row.dataset.status;
            const total = parseFloat(row.dataset.total);
            
            if (status === 'pending') stats.pending++;
            if (status === 'processing') stats.processing++;
            if (status === 'completed') stats.revenue += total;
        });
        
        // Update stat cards
        const totalOrdersCount = document.getElementById('totalOrdersCount');
        const pendingOrdersCount = document.getElementById('pendingOrdersCount');
        const processingOrdersCount = document.getElementById('processingOrdersCount');
        const totalRevenueCount = document.getElementById('totalRevenueCount');
        
        if (totalOrdersCount) totalOrdersCount.textContent = stats.total;
        if (pendingOrdersCount) pendingOrdersCount.textContent = stats.pending;
        if (processingOrdersCount) processingOrdersCount.textContent = stats.processing;
        if (totalRevenueCount) totalRevenueCount.textContent = `DH${Math.round(stats.revenue)}`;
    }
    
    function toggleSelectAll() {
        const visibleCheckboxes = Array.from(document.querySelectorAll('.order-checkbox'))
            .filter(cb => cb.closest('.order-row').style.display !== 'none');
        
        visibleCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateBulkActions();
    }
    
    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
        const count = checkedBoxes.length;
        
        selectedCount.textContent = count;
        
        if (count > 0) {
            bulkActionsBar.classList.remove('d-none');
        } else {
            bulkActionsBar.classList.add('d-none');
        }
        
        // Update select all checkbox
        const visibleCheckboxes = Array.from(document.querySelectorAll('.order-checkbox'))
            .filter(cb => cb.closest('.order-row').style.display !== 'none');
        const allChecked = visibleCheckboxes.length > 0 && visibleCheckboxes.every(cb => cb.checked);
        const someChecked = visibleCheckboxes.some(cb => cb.checked);
        
        selectAll.checked = allChecked;
        selectAll.indeterminate = someChecked && !allChecked;
    }
    
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Make functions globally available
    window.clearSearch = function() {
        customerSearch.value = '';
        filterOrders();
    };
    
    window.clearAllFilters = function() {
        statusFilter.value = '';
        customerSearch.value = '';
        sortOrder.value = 'date-desc';
        selectAll.checked = false;
        document.querySelectorAll('.order-checkbox:checked').forEach(cb => cb.checked = false);
        filterOrders();
    };
    
    window.refreshOrders = function() {
        location.reload();
    };
    
    window.exportOrders = function() {
        const visibleOrders = Array.from(orderRows).filter(row => row.style.display !== 'none');
        const data = visibleOrders.map(row => ({
            id: row.dataset.orderId,
            customer: row.querySelector('.customer-info strong').textContent,
            email: row.querySelector('.customer-info small').textContent,
            date: row.dataset.date,
            total: row.dataset.total,
            status: row.dataset.status
        }));
        
        const csv = [
            ['Order ID', 'Customer', 'Email', 'Date', 'Total', 'Status'],
            ...data.map(order => [order.id, order.customer, order.email, order.date, order.total, order.status])
        ].map(row => row.join(',')).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `orders-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    };
    
    window.bulkUpdateStatus = function(newStatus) {
        const selectedOrders = Array.from(document.querySelectorAll('.order-checkbox:checked'));
        if (selectedOrders.length === 0) return;
        
        if (confirm(`Update ${selectedOrders.length} orders to ${newStatus}?`)) {
            selectedOrders.forEach(checkbox => {
                const orderId = checkbox.value;
                const row = checkbox.closest('.order-row');
                
                // Update the display immediately
                row.dataset.status = newStatus;
                const statusBadge = row.querySelector('.order-status');
                statusBadge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                statusBadge.className = `badge order-status bg-${getStatusColor(newStatus)}`;
                
                // Send update to server (you'd implement this)
                // fetch(`/admin/orders/${orderId}/update_status`, {...})
            });
            
            filterOrders();
        }
    };
    
    window.bulkDelete = function() {
        const selectedOrders = Array.from(document.querySelectorAll('.order-checkbox:checked'));
        if (selectedOrders.length === 0) return;
        
        if (confirm(`Delete ${selectedOrders.length} orders? This action cannot be undone.`)) {
            selectedOrders.forEach(checkbox => {
                const row = checkbox.closest('.order-row');
                row.remove();
            });
            
            filterOrders();
        }
    };
    
    function getStatusColor(status) {
        switch(status) {
            case 'pending': return 'warning';
            case 'processing': return 'info';
            case 'shipped': return 'primary';
            case 'delivered':
            case 'completed': return 'success';
            case 'cancelled': return 'danger';
            default: return 'secondary';
        }
    }
});
</script>

<style>
.btn-group .dropdown-menu {
  min-width: 120px;
}

.dropdown-item.active {
  background-color: #0d6efd;
  color: white;
}

.order-row {
  transition: all 0.3s ease;
}

.table-responsive {
  transition: opacity 0.3s ease;
}

#bulkActionsBar {
  background-color: #f8f9fa;
  border-top: 1px solid #dee2e6;
}

.customer-info {
  min-width: 150px;
}

@media (max-width: 768px) {
  .btn-group {
    display: block;
  }
  
  .btn-group .btn {
    display: block;
    width: 100%;
    margin-bottom: 2px;
  }
  
  .card-body .row > div {
    margin-bottom: 1rem;
  }
}
</style>
{% endblock %}